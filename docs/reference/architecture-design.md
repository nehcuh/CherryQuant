# CherryQuant 系统架构文档

## 项目概述

CherryQuant 是一个基于 AI 驱动的中国期货市场自动化交易系统。项目名称来源于 "Cherry"（樱桃）和 "Quant"（量化）的结合，寓意着精准、高效的量化交易。

### 核心理念

1. **AI 驱动决策** - 使用大语言模型（LLM）进行交易决策
2. **境内期货专注** - 专门针对中国期货市场优化
3. **风险控制优先** - 严格的风险管理和仓位控制
4. **快速原型迭代** - 先求可用，再求完善

## 系统架构

```
CherryQuant AI期货交易系统
├── 数据层 (Data Layer)
│   ├── QuantBox 数据服务 - 高性能期货历史与日内数据（封装 Tushare / 行情源）
│   ├── 实时行情聚合 - vn.py Tick → 多周期K线 (RealtimeRecorder)
│   ├── 技术指标计算 - MA、MACD、RSI 等 (基于 Pandas/NumPy)
│   └── 数据预处理与持久化 - 标准化后写入 MongoDB 时间序列集合
│
├── AI决策层 (AI Decision Layer)
│   ├── 提示词工程 - 基于nof1.ai的设计理念
│   ├── LLM客户端 - OpenAI GPT/Claude等
│   ├── 决策解析 - JSON格式交易信号
│   └── 置信度评估 - 交易信号可信度
│
├── 策略执行层 (Strategy Execution Layer)
│   ├── vn.py框架集成 - 专业交易基础设施
│   ├── 仓位管理 - 持仓跟踪和风险控制
│   ├── 订单执行 - 自动下单和平仓
│   └── 止损止盈 - 自动化风险管理
│
├── 监控层 (Monitoring Layer)
│   ├── 实时日志 - 交易过程记录
│   ├── 性能统计 - 盈亏和风险指标
│   ├── 通知系统 - 重要事件提醒
│   └── Web界面 - 可视化监控（规划中）
│
└── 配置层 (Configuration Layer)
    ├── 交易参数 - 合约、杠杆、仓位限制
    ├── AI参数 - 模型选择、温度设置
    ├── 风控参数 - 止损比例、最大回撤
    └── CTP配置 - 期货公司接口设置
```

## 核心模块说明

### 1. AI决策引擎 (ai/decision_engine/futures_engine.py)

**功能：**
- 获取市场数据和技术指标
- 构造AI提示词
- 调用大语言模型
- 解析和验证交易决策

**关键特性：**
- 基于 nof1.ai 的提示词设计理念
- 支持多种技术指标分析
- 自动JSON格式验证
- 置信度评估机制

### 2. LLM客户端 (ai/llm_client/openai_client.py)

**功能：**
- 封装OpenAI API调用
- 异步请求处理
- 错误处理和重试机制
- JSON响应解析

**支持模型：**
- GPT-4 / GPT-3.5 Turbo
- Claude（未来支持）
- 其他兼容模型

### 3. vn.py策略 (src/cherryquant/cherry_quant_strategy.py)

**功能：**
- 继承vn.py策略基类
- 实现AI信号执行
- 仓位管理和风险控制
- 交易状态跟踪

**交易逻辑：**
```
K线数据更新 → 定时AI决策 → 信号验证 → 订单执行 → 持仓管理
```

### 4. 提示词系统 (ai/prompts/futures_prompts.py)

**设计理念：**
- 基于 nof1.ai 成熟的提示词架构
- 适配中国期货市场特点
- 强制结构化JSON输出
- 完整的风险管理协议

**核心组成部分：**
- **System Prompt**: 定义AI交易员角色和规则
- **User Prompt Template**: 动态填充市场数据
- **输出格式**: 标准化JSON交易信号

## 数据流架构

```
1. 市场数据获取
   QuantBox (历史数据) / vn.py-CTP (实时 Tick) → K线聚合与技术指标计算 → 写入 MongoDB

2. AI决策流程
   市场数据 + 提示词模板 → LLM API → 交易决策JSON

3. 信号执行流程
   JSON信号 → 验证和风控 → vn.py API → 交易所

4. 反馈循环
   成交回报 → 持仓更新 → 下次AI决策输入
```

## 技术选型

### 核心框架
- **vn.py**: 成熟的量化交易平台
  - 完整的CTP接口封装
  - 专业的风控系统
  - 丰富的技术指标库
  - 可视化界面支持

### AI技术栈
- **OpenAI GPT**: 主要决策模型
- **提示词工程**: 基于nof1.ai最佳实践
- **异步处理**: 支持高频决策

### 数据源
- **QuantBox-CN**: 主要历史数据源（Tushare 协议封装）
  - 期货历史 K 线（多周期）
  - 合约信息与主力合约解析辅助
- **vn.py / CTP**: 实时行情与交易通道
  - Tick 实时数据
  - 委托与成交回报
- **MongoDB 时间序列集合**: 统一的 K 线与指标存储层

### 开发工具
- **Python 3.12**: 主要开发语言
- **uv**: 包管理和虚拟环境
- **asyncio**: 异步编程框架

## 风险控制架构

### 多层级风控

1. **AI层风控**
   - 置信度阈值过滤
   - 强制止损止盈设置
   - 仓位大小建议

2. **策略层风控**
   - 最大持仓限制
   - 单笔风险控制
   - 时间间隔控制

3. **框架层风控**（vn.py）
   - 资金检查
   - 仓位验证
   - 订单状态监控

4. **配置层风控**
   - 全局参数设置
   - 紧急停止机制
   - 风险指标监控

### 风控指标

- **每笔风险**: 控制在1-3%账户资金
- **日最大亏损**: 5%账户资金
- **最大回撤**: 15%限制
- **杠杆控制**: 1-10倍可调

## 部署架构

### 开发环境
```bash
# 环境配置
Python 3.12 + uv包管理器
本地模拟交易模式
日志和监控开发
```

### 生产环境（规划）
```bash
# 实盘环境
云服务器部署
专用CTP通道
实时监控系统
自动报警机制
```

## 扩展性设计

### 模块化架构
- 每个模块独立可替换
- 支持多种数据源
- 支持多种AI模型
- 支持多种交易所

### 插件化策略
- 策略可插拔设计
- 支持多策略并行
- 策略组合管理
- 动态参数调整

## 性能考虑

### 响应时间
- AI决策: < 5秒
- 数据获取: < 1秒
- 订单执行: < 0.5秒
- 总延迟: < 10秒

### 并发处理
- 异步数据获取
- 多合约并行分析
- 并行策略执行
- 非阻塞I/O处理

## 安全设计

### API密钥管理
- 环境变量存储
- 本地加密保存
- 权限最小化原则

### 交易安全
- 模拟模式强制测试
- 实盘模式双重确认
- 紧急停止机制
- 异常自动恢复

## 监控和日志

### 日志级别
- **DEBUG**: 详细调试信息
- **INFO**: 重要交易事件
- **WARNING**: 风险提示
- **ERROR**: 错误和异常

### 监控指标
- 交易性能指标
- AI决策质量
- 系统健康状态
- 风险控制效果

## 未来规划

### 短期目标（1-2周）
- ✅ MVP版本实现
- ✅ 模拟交易测试
- ⏳ 完善风控机制
- ⏳ Web监控界面

### 中期目标（1-2月）
- 多策略支持
- 实盘部署
- 性能优化
- 回测系统

### 长期目标（3-6月）
- 多交易所支持
- 组合策略
- 机器学习优化
- 机构级风控

---

**文档版本**: v1.0
**创建日期**: 2025-10-29
**最后更新**: 2025-10-29