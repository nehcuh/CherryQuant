# é£é™©é…ç½®ç®¡ç†æŒ‡å—

## æ¦‚è¿°

CherryQuant ç°åœ¨æ”¯æŒçµæ´»çš„é£é™©å‚æ•°é…ç½®ï¼Œæ‚¨å¯ä»¥é€šè¿‡ `.env` æ–‡ä»¶æˆ– JSON é…ç½®æ–‡ä»¶æ¥ç®¡ç†é£é™©å‚æ•°ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

## é…ç½®æ–¹å¼

### æ–¹å¼ 1ï¼šé€šè¿‡ .env æ–‡ä»¶é…ç½®ï¼ˆæ¨èï¼‰

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ä¸­æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

```bash
# ===== ç»„åˆé£é™©ç®¡ç†é…ç½® =====
PORTFOLIO_MAX_CAPITAL_USAGE=0.8       # æœ€å¤§æ€»èµ„é‡‘ä½¿ç”¨ç‡ (0-1)
PORTFOLIO_MAX_CORRELATION=0.7         # æœ€å¤§ç›¸å…³æ€§é˜ˆå€¼ (0-1)
PORTFOLIO_MAX_SECTOR_CONCENTRATION=0.4  # æœ€å¤§å•ä¸€æ¿å—é›†ä¸­åº¦ (0-1)
PORTFOLIO_STOP_LOSS=0.1               # ç»„åˆæ­¢æŸæ¯”ä¾‹ (0-0.5)
PORTFOLIO_DAILY_LOSS_LIMIT=0.05       # æ¯æ—¥äºæŸé™åˆ¶ (0-0.5)
PORTFOLIO_MAX_LEVERAGE=3.0            # æ€»æ æ†é™åˆ¶ (1-10)
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•ç›´è§‚ï¼Œé”®å€¼å¯¹æ ¼å¼
- âœ… æ”¯æŒå¤šç¯å¢ƒåˆ‡æ¢ï¼ˆdev/prodï¼‰
- âœ… Docker/K8s éƒ¨ç½²å‹å¥½
- âœ… æ— éœ€é‡å¯å³å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–

### æ–¹å¼ 2ï¼šé€šè¿‡ strategies.json é…ç½®æ¿å—æ˜ å°„

åœ¨ `config/strategies.json` ä¸­è‡ªå®šä¹‰æ¿å—åˆ†ç±»ï¼š

```json
{
  "sector_mapping": {
    "rb": "é»‘è‰²é‡‘å±",
    "hc": "é»‘è‰²é‡‘å±",
    "i": "é»‘è‰²é‡‘å±",
    "cu": "æœ‰è‰²é‡‘å±",
    "al": "æœ‰è‰²é‡‘å±",
    "au": "è´µé‡‘å±",
    "ag": "è´µé‡‘å±",
    "a": "å†œäº§å“",
    "m": "å†œäº§å“",
    "pp": "åŒ–å·¥",
    "l": "åŒ–å·¥",
    "IF": "é‡‘è",
    "IC": "é‡‘è"
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ”¯æŒå¤æ‚çš„åµŒå¥—ç»“æ„
- âœ… å¯ä»¥æ·»åŠ æ³¨é‡Šå’Œæ–‡æ¡£
- âœ… ç‰ˆæœ¬æ§åˆ¶å‹å¥½ï¼ˆGit diffï¼‰
- âœ… ç”¨æˆ·å¯è‡ªå®šä¹‰æ¿å—åˆ†ç±»

---

## é…ç½®å‚æ•°è¯´æ˜

### 1. PORTFOLIO_MAX_CAPITAL_USAGE
- **ç±»å‹**ï¼šfloat (0-1)
- **é»˜è®¤å€¼**ï¼š0.8
- **è¯´æ˜**ï¼šæœ€å¤§èµ„é‡‘ä½¿ç”¨ç‡ï¼Œè¶…è¿‡æ­¤æ¯”ä¾‹å°†è§¦å‘é£é™©æ§åˆ¶
- **ç¤ºä¾‹**ï¼š0.8 è¡¨ç¤ºæœ€å¤šä½¿ç”¨ 80% çš„æ€»èµ„é‡‘

### 2. PORTFOLIO_MAX_CORRELATION
- **ç±»å‹**ï¼šfloat (0-1)
- **é»˜è®¤å€¼**ï¼š0.7
- **è¯´æ˜**ï¼šç­–ç•¥ä¹‹é—´çš„æœ€å¤§ç›¸å…³æ€§é˜ˆå€¼
- **ç¤ºä¾‹**ï¼š0.7 è¡¨ç¤ºç›¸å…³æ€§è¶…è¿‡ 70% æ—¶è§¦å‘è­¦å‘Š

### 3. PORTFOLIO_MAX_SECTOR_CONCENTRATION
- **ç±»å‹**ï¼šfloat (0-1)
- **é»˜è®¤å€¼**ï¼š0.4
- **è¯´æ˜**ï¼šå•ä¸€æ¿å—çš„æœ€å¤§æŒä»“é›†ä¸­åº¦
- **ç¤ºä¾‹**ï¼š0.4 è¡¨ç¤ºå•ä¸€æ¿å—æŒä»“ä¸è¶…è¿‡æ€»æŒä»“çš„ 40%

### 4. PORTFOLIO_STOP_LOSS
- **ç±»å‹**ï¼šfloat (0-0.5)
- **é»˜è®¤å€¼**ï¼š0.1
- **è¯´æ˜**ï¼šç»„åˆçº§åˆ«æ­¢æŸæ¯”ä¾‹
- **ç¤ºä¾‹**ï¼š0.1 è¡¨ç¤ºç»„åˆäºæŸ 10% æ—¶å¹³ä»“æ‰€æœ‰ç­–ç•¥

### 5. PORTFOLIO_DAILY_LOSS_LIMIT
- **ç±»å‹**ï¼šfloat (0-0.5)
- **é»˜è®¤å€¼**ï¼š0.05
- **è¯´æ˜**ï¼šæ¯æ—¥äºæŸé™åˆ¶
- **ç¤ºä¾‹**ï¼š0.05 è¡¨ç¤ºå½“æ—¥äºæŸè¾¾åˆ°åˆå§‹èµ„é‡‘çš„ 5% æ—¶æš‚åœæ‰€æœ‰ç­–ç•¥

### 6. PORTFOLIO_MAX_LEVERAGE
- **ç±»å‹**ï¼šfloat (1-10)
- **é»˜è®¤å€¼**ï¼š3.0
- **è¯´æ˜**ï¼šæ€»æ æ†é™åˆ¶
- **ç¤ºä¾‹**ï¼š3.0 è¡¨ç¤ºå…è®¸çš„æœ€å¤§æ€»æ æ†ä¸º 3 å€

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1ï¼šä¿å®ˆå‹é…ç½®

```bash
# .env
PORTFOLIO_MAX_CAPITAL_USAGE=0.6       # åªä½¿ç”¨ 60% èµ„é‡‘
PORTFOLIO_MAX_SECTOR_CONCENTRATION=0.3  # å•æ¿å—ä¸è¶…è¿‡ 30%
PORTFOLIO_STOP_LOSS=0.05              # 5% ç»„åˆæ­¢æŸ
PORTFOLIO_DAILY_LOSS_LIMIT=0.03       # 3% æ¯æ—¥æ­¢æŸ
PORTFOLIO_MAX_LEVERAGE=2.0            # æœ€å¤§ 2 å€æ æ†
```

### åœºæ™¯ 2ï¼šæ¿€è¿›å‹é…ç½®

```bash
# .env
PORTFOLIO_MAX_CAPITAL_USAGE=0.95      # ä½¿ç”¨ 95% èµ„é‡‘
PORTFOLIO_MAX_SECTOR_CONCENTRATION=0.6  # å•æ¿å—å¯è¾¾ 60%
PORTFOLIO_STOP_LOSS=0.15              # 15% ç»„åˆæ­¢æŸ
PORTFOLIO_DAILY_LOSS_LIMIT=0.08       # 8% æ¯æ—¥æ­¢æŸ
PORTFOLIO_MAX_LEVERAGE=5.0            # æœ€å¤§ 5 å€æ æ†
```

### åœºæ™¯ 3ï¼šå¤šç¯å¢ƒé…ç½®

```bash
# .env.dev (å¼€å‘ç¯å¢ƒ)
PORTFOLIO_MAX_CAPITAL_USAGE=0.5
PORTFOLIO_STOP_LOSS=0.03
PORTFOLIO_MAX_LEVERAGE=1.5

# .env.prod (ç”Ÿäº§ç¯å¢ƒ)
PORTFOLIO_MAX_CAPITAL_USAGE=0.8
PORTFOLIO_STOP_LOSS=0.1
PORTFOLIO_MAX_LEVERAGE=3.0
```

### åœºæ™¯ 4ï¼šè‡ªå®šä¹‰æ¿å—åˆ†ç±»

å¦‚æœæ‚¨æƒ³æŒ‰ç…§è‡ªå·±çš„æ–¹å¼åˆ†ç±»å“ç§ï¼š

```json
{
  "sector_mapping": {
    "rb": "å»ºç­‘ææ–™",
    "hc": "å»ºç­‘ææ–™",
    "i": "é’¢é“åŸæ–™",
    "j": "é’¢é“åŸæ–™",
    "cu": "å·¥ä¸šé‡‘å±",
    "al": "å·¥ä¸šé‡‘å±",
    "au": "é¿é™©èµ„äº§",
    "ag": "é¿é™©èµ„äº§",
    "a": "ç²®æ²¹é¥²æ–™",
    "m": "ç²®æ²¹é¥²æ–™"
  }
}
```

---

## éªŒè¯é…ç½®

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®ï¼š

```bash
uv run python test_risk_config.py
```

**é¢„æœŸè¾“å‡º**ï¼š

```
============================================================
æµ‹è¯• 1: ä» .env åŠ è½½é£é™©é…ç½®
============================================================
âœ… æœ€å¤§èµ„é‡‘ä½¿ç”¨ç‡: 0.8
âœ… æœ€å¤§ç›¸å…³æ€§é˜ˆå€¼: 0.7
âœ… æœ€å¤§æ¿å—é›†ä¸­åº¦: 0.4
âœ… ç»„åˆæ­¢æŸæ¯”ä¾‹: 0.1
âœ… æ¯æ—¥äºæŸé™åˆ¶: 0.05
âœ… æœ€å¤§æ€»æ æ†: 3.0
âœ… ä» .env åŠ è½½é£é™©é…ç½®æµ‹è¯•é€šè¿‡ï¼

...

============================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼é£é™©é…ç½®ç³»ç»Ÿå·¥ä½œæ­£å¸¸
============================================================
```

---

## æŸ¥çœ‹å½“å‰é…ç½®

è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„é…ç½®ï¼š

```bash
uv run python -c "from config.settings.base import CONFIG; CONFIG.print_summary()"
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
============================================================
ğŸ“‹ CherryQuant é…ç½®æ‘˜è¦
============================================================
ğŸŒ è¿è¡Œç¯å¢ƒ: development
ğŸ› è°ƒè¯•æ¨¡å¼: False
ğŸ• æ—¶åŒº: Asia/Shanghai

ğŸ“Š æ•°æ®æ¨¡å¼: dev
ğŸ“¡ æ•°æ®æº: tushare
ğŸ¤– AIæ¨¡å‹: gpt-4
ğŸ’¾ MongoDB: mongodb://localhost:27017/cherryquant
ğŸ—ƒï¸  Redisç¼“å­˜: localhost:6379/0
ğŸ“ æ—¥å¿—çº§åˆ«: INFO
ğŸ“ æ—¥å¿—ç›®å½•: ./logs

ğŸ›¡ï¸  é£é™©ç®¡ç†é…ç½®:
  - æœ€å¤§èµ„é‡‘ä½¿ç”¨ç‡: 80%
  - ç»„åˆæ­¢æŸ: 10%
  - æ¯æ—¥äºæŸé™åˆ¶: 5%
  - æœ€å¤§æ¿å—é›†ä¸­åº¦: 40%
  - æœ€å¤§æ€»æ æ†: 3.0x
============================================================
```

---

## ä»£ç ä¸­ä½¿ç”¨

### æ–¹å¼ 1ï¼šè‡ªåŠ¨ä» CONFIG åŠ è½½ï¼ˆæ¨èï¼‰

```python
from src.cherryquant.ai.agents.agent_manager import AgentManager

# è‡ªåŠ¨ä»å…¨å±€ CONFIG åŠ è½½é£é™©é…ç½®
manager = AgentManager()

# é£é™©é…ç½®å·²è‡ªåŠ¨åº”ç”¨
print(manager.risk_config.max_total_capital_usage)  # 0.8
print(manager.risk_config.portfolio_stop_loss)      # 0.1
```

### æ–¹å¼ 2ï¼šæ‰‹åŠ¨ä¼ å…¥è‡ªå®šä¹‰é…ç½®

```python
from src.cherryquant.ai.agents.agent_manager import AgentManager, PortfolioRiskConfig

# åˆ›å»ºè‡ªå®šä¹‰é£é™©é…ç½®
custom_risk = PortfolioRiskConfig(
    max_total_capital_usage=0.6,
    max_correlation_threshold=0.5,
    max_sector_concentration=0.3,
    portfolio_stop_loss=0.05,
    daily_loss_limit=0.03,
    max_leverage_total=2.0,
)

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
manager = AgentManager(risk_config=custom_risk)
```

---

## æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒä½¿ç”¨ä¿å®ˆé…ç½®
```bash
# .env.dev
PORTFOLIO_MAX_CAPITAL_USAGE=0.5
PORTFOLIO_STOP_LOSS=0.03
PORTFOLIO_MAX_LEVERAGE=1.5
```

### 2. ç”Ÿäº§ç¯å¢ƒæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
```bash
# .env.prod
PORTFOLIO_MAX_CAPITAL_USAGE=0.8
PORTFOLIO_STOP_LOSS=0.1
PORTFOLIO_MAX_LEVERAGE=3.0
```

### 3. ä½¿ç”¨ Docker éƒ¨ç½²æ—¶é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–

```yaml
# docker-compose.yml
services:
  cherryquant:
    image: cherryquant:latest
    environment:
      - PORTFOLIO_MAX_CAPITAL_USAGE=0.7
      - PORTFOLIO_STOP_LOSS=0.08
      - PORTFOLIO_MAX_LEVERAGE=2.5
```

### 4. å®šæœŸå®¡æŸ¥å’Œè°ƒæ•´é…ç½®

- ğŸ“Š æ¯æœˆå›é¡¾é£é™©å‚æ•°çš„æœ‰æ•ˆæ€§
- ğŸ“ˆ æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡è°ƒæ•´æ­¢æŸæ¯”ä¾‹
- ğŸ” ç›‘æ§æ¿å—é›†ä¸­åº¦ï¼Œå¿…è¦æ—¶è°ƒæ•´é˜ˆå€¼

---

## æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šé…ç½®æœªç”Ÿæ•ˆ

**åŸå› **ï¼š.env æ–‡ä»¶æœªæ­£ç¡®åŠ è½½

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ .env æ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•
2. é‡å¯åº”ç”¨ï¼ˆé…ç½®åœ¨å¯åŠ¨æ—¶åŠ è½½ï¼‰
3. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰åŠ è½½æˆåŠŸæç¤º

### é—®é¢˜ 2ï¼šæ¿å—æ˜ å°„ä¸æ­£ç¡®

**åŸå› **ï¼šstrategies.json ä¸­ sector_mapping é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è¿è¡Œ `uv run python test_risk_config.py` éªŒè¯
2. æ£€æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ¿å—æ˜ å°„åŠ è½½ä¿¡æ¯

### é—®é¢˜ 3ï¼šå‚æ•°éªŒè¯å¤±è´¥

**åŸå› **ï¼šå‚æ•°è¶…å‡ºå…è®¸èŒƒå›´

**é”™è¯¯ç¤ºä¾‹**ï¼š
```
ValueError: Value must be between 0 and 1, got 1.5
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ£€æŸ¥å‚æ•°èŒƒå›´ï¼š
- ç™¾åˆ†æ¯”å‚æ•°ï¼ˆèµ„é‡‘ä½¿ç”¨ç‡ã€æ¿å—é›†ä¸­åº¦ï¼‰ï¼š0-1
- æ­¢æŸå‚æ•°ï¼š0-0.5
- æ æ†å‚æ•°ï¼š1-10

---

## æŠ€æœ¯ç»†èŠ‚

### é…ç½®åŠ è½½ä¼˜å…ˆçº§

1. **ä»£ç ä¼ å…¥çš„é…ç½®** > 2. **.env ç¯å¢ƒå˜é‡** > 3. **é»˜è®¤å€¼**

### é…ç½®éªŒè¯

æ‰€æœ‰å‚æ•°éƒ½ç»è¿‡ Pydantic éªŒè¯ï¼Œç¡®ä¿å‚æ•°åœ¨åˆæ³•èŒƒå›´å†…ã€‚

### å‘åå…¼å®¹æ€§

- âœ… å¦‚æœæœªé…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
- âœ… æ”¯æŒæ—§ä»£ç ç›´æ¥å®ä¾‹åŒ– `AgentManager()`
- âœ… æ¿å—æ˜ å°„å¦‚æœåŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°é»˜è®¤æ˜ å°„

---

## ç›¸å…³æ–‡ä»¶

- `config/settings/base.py` - é…ç½®ç±»å®šä¹‰
- `config/strategies.json` - æ¿å—æ˜ å°„é…ç½®
- `.env` - ç¯å¢ƒå˜é‡é…ç½®
- `src/cherryquant/ai/agents/agent_manager.py` - é£é™©ç®¡ç†å®ç°
- `test_risk_config.py` - é…ç½®æµ‹è¯•è„šæœ¬

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-13
**ç‰ˆæœ¬**: v0.2.0
