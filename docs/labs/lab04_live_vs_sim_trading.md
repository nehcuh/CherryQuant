# Lab 04: 模拟账户 vs 实盘执行 与 PnL 对账实验

> 本实验聚焦 CherryQuant 中最具教学价值的一条链路：
> **AI 决策 → 模拟账户 → KLineOrderManager 实盘订单 → 实盘成交回流 → PnL 可视化**。
>
> 你将亲手运行完整系统、触发若干笔交易，并从 Web 面板与 Notebook 两个视角，对比
> "理想世界"（模拟账户）与 "真实市场"（实盘执行）的差异。

---

## 一、实验信息

- **难度**: ⭐⭐⭐ 中级
- **预计时间**: 4 小时
- **相关模块**:
  - Module 3: AI 决策引擎
  - Module 4: 交易执行
  - Module 5: 系统集成
- **建议进度**: 完成 Lab 01-03 后进行

### 前置要求

- [x] 能够运行 `scripts/runners/run_cherryquant_complete.py`
- [x] 理解 CherryQuant 的基本架构 (`docs/reference/architecture.md`)
- [x] 基本掌握 `asyncio` 与 REST API 的使用

> ⚠️ 提醒：本实验默认在 **Dev / 模拟环境** 下进行，不强制接入真实 CTP。
> 即使没有真实实盘，也可以通过 "伪实盘" 观察完整闭环行为。

---

## 二、学习目标

完成本实验后，你应该能够：

1. 画出从 AI 决策到实盘成交的完整调用链，并在代码中找到对应实现。
2. 理解 CherryQuant 中 **模拟账户** 与 **实盘执行** 有意分离的原因。
3. 使用 Web 前端观察单个策略的：
   - 模拟交易笔数 / 实盘执行笔数；
   - 模拟 vs 实盘 累计 PnL 曲线；
   - PnL 差值 (Live - Sim)。
4. 使用 Notebook 进行更精细的 PnL 分析，并编写自己的 "对账指标"。
5. 能够解释：为什么生产系统需要 "对账与回写"，而教学版选择保留偏差。

---

## 三、实验步骤

### 步骤 1：启动完整系统（包含 Web + API + 多策略）

1. 确保虚拟环境与依赖安装完好：
   ```bash
   uv sync
   ```

2. 在项目根目录启动完整系统：
   ```bash
   uv run python scripts/runners/run_cherryquant_complete.py
   ```

3. 观察启动日志，确认：
   - ✅ MongoDB / Redis 连接成功；
   - ✅ PortfolioRiskManager / AlertManager 启动；
   - ✅ AgentManager 从 `config/strategies.json` 加载了若干策略；
   - ✅ Web API `CherryQuant API` 正在监听 (默认端口 8000)。

4. 打开浏览器访问：
   - `http://localhost:8000/`（Web 监控界面）
   - `http://localhost:8000/docs`（API 文档）

> 实验报告中请粘贴一段启动日志（至少包含系统各子组件的“✅”行）。

---

### 步骤 2：理解模拟账户 vs 实盘执行的架构

1. 阅读文档 `docs/reference/architecture.md` 中的章节：
   - "交易执行流程"
   - "模拟账户 vs 实盘执行（教学设计说明）"

2. 在实验报告中用你自己的话回答：
   - Q1: 为何 CherryQuant 要同时保留 **模拟账户** 与 **实盘执行** 两条路径？
   - Q2: 在当前教学版中，**实盘成交会不会反向改写模拟账户的持仓与 PnL？为何？**
   - Q3: PnL 计算中有哪些刻意的简化？这些简化对教学有什么好处 / 风险？

3. 在代码中定位以下关键点（给出文件路径与函数名即可）：
   - 模拟买入 / 卖出逻辑（更新模拟账户）
   - 通过 `KLineOrderManager` 发送真实订单的代码
   - 处理实盘成交回报并写入 `live_executions` 的代码
   - Web API 返回 `sim_pnl` / `live_pnl` 以及 `pnl_diff` 的代码

> ✅ 检查点：你应能在课堂上用一张图解释“AI 决策 → 模拟账户 → 实盘订单 → 实盘成交回流 → PnL 可视化”。

---

### 步骤 3：在 Web 界面中观察执行与 PnL 曲线

1. 打开 Web 首页 `http://localhost:8000/`：
   - 顶部是系统整体指标（组合总价值、总 PnL、活跃策略数等）；
   - 中部是“📋 策略状态”列表，列出每个策略的账户价值、收益率、交易数等；
   - 底部是“🎯 策略执行对比（模拟 vs 实盘）”区域。

2. 在“策略状态”列表中**点击任意一个策略卡片**（建议从 `trend_following_01` 开始）：
   - 观察下方对比区域出现的内容：
     - 模拟交易笔数 (recent_trades)
     - 实盘执行笔数 (live_executions)
     - 模拟累计 PnL / 实盘累计 PnL
     - PnL 差值 (实盘 - 模拟)
     - 最近几条模拟交易与实盘执行明细
     - 一张双曲线 PnL 图（蓝：Sim，橙：Live）

3. 尝试调整控制条：
   - 时间范围：全部 / 最近 30 分钟 / 最近 2 小时 / 最近 1 天
   - 显示模拟 PnL / 显示实盘 PnL 勾选框

4. 在实验报告中回答：
   - Q4: 当你只勾选“显示模拟 PnL”时，曲线形状是什么样的？
   - Q5: 当只勾选“显示实盘 PnL”时，有什么不同？（如果 Live 为空，可以假设未来有真实成交）
   - Q6: PnL 差值为正 / 为负时，你会如何向非技术同学解释其含义？

> 提示：如果你暂时没有真实 CTP 环境，也可以在未来接入实盘时再次做这一步；本实验更强调**界面与数据结构的理解**。

---

### 步骤 4：在 Notebook 中做更精细的 PnL 回测与对账

1. 打开 `notebooks/ai_trading_live_vs_sim.py` 文件，将其导入 Jupyter / VS Code Notebook。

2. 逐 cell 执行，理解以下函数：
   - `fetch_strategy_executions(strategy_id)`：调用 Web API `/executions` 获取 data
   - `compute_simulated_pnl(sim_df)`：基于 `recent_trades` 的 PnL 累加
   - `compute_live_pnl(live_df)`：基于 `live_executions` 的简化撮合算法

3. 修改 Notebook，增加你自己的“对账指标”，例如：
   - `max_abs_diff`: 整个区间内 |live_pnl - sim_pnl| 的最大值
   - `mean_diff`: 平均差值
   - `drift_ratio`: 最终差值 / 模拟最终 PnL（相对偏差）

4. 在 Notebook 中画出：
   - 同一张图上的 Sim PnL 与 Live PnL 曲线
   - 另一张图：时间轴上的 `live - sim` 差值曲线（如果有数据）

5. 在实验报告中粘贴：
   - 关键代码（指标计算 / 绘图部分）
   - 图像截图
   - 对结果的分析（不少于 300 字）

> 建议将 Notebook 保存为 `lab04_live_vs_sim_trading.ipynb`，并与实验报告一起提交。

---

### 步骤 5：设计一个“理想的生产对账机制”（思考题）

当前 CherryQuant 教学版本**不会**拿实盘执行去改写模拟账户，只是通过 PnL 曲线和差值指标展示偏差。

请在报告中思考并回答：

1. 如果要在生产系统中真正实现“对账与回写”，你认为需要哪些步骤？（提示：数据源、对账逻辑、异常处理、告警）
2. 你会如何设计一个“对账模式开关”？例如：
   - `reporting_mode = "sim" | "live" | "mixed"`
   - 在不同模式下，哪些报表/指标应该使用 Sim 数据，哪些应该使用 Live 数据？
3. 在极端行情下（如闪崩），Sim PnL 与 Live PnL 可能严重偏离，你会如何：
   - 监控和告警？
   - 向风控 / 管理层解释？
   - 在系统层面做预防？

> 这一部分不要求你写代码，但要体现你对**系统工程**的思考。

---

## 四、实验提交内容

1. 实验报告（Markdown 或 PDF），建议结构：
   - 实验目标
   - 实验环境
   - 实验步骤与关键截图
   - 自定义对账指标与代码
   - 结果分析与思考
   - 小结与改进建议
2. Notebook 文件：
   - `lab04_live_vs_sim_trading.ipynb`
3. （可选）你修改过的任何辅助脚本或配置

---

## 五、评分建议（供教师/助教参考）

- **功能完成度 (40%)**
  - 能否运行完整系统和 Web 面板
  - 是否成功调用 `/executions` API 并在 Notebook 中处理数据
- **分析深度 (30%)**
  - 是否对 Sim vs Live 的差异给出合理解释
  - 对对账机制的思考是否具体、可行
- **表达与文档 (20%)**
  - 实验报告条理是否清晰
  - 图表与代码是否易读
- **拓展与创新 (10%)**
  - 是否设计了额外对账指标 / 可视化
  - 是否提出有价值的系统改进建议

---

祝你在本实验中，不只是“跑通系统”，而是真正理解一条现代量化系统中最重要的链路：

> 从 **模型世界** 走向 **真实市场** 的那一步，以及二者之间永远存在的偏差。🚀

---

## 六、后续拓展与课程优化建议

本实验是当前课程中关于「Sim vs Live + PnL 对账」的基础版本，为后续优化预留了若干自然的升级方向：

1. **实现软 / 硬对账模式**  
   - 在报告中设计的 `reporting_mode` 真正落地到代码中；  
   - 保持当前「教学安全模式」不变的前提下，引入一个「高级实验分支」。
2. **扩展到多策略组合与多账户场景**  
   - 让学生尝试：将不同策略映射到不同“虚拟账户”，观察 Sim vs Live 在组合层面的偏差；  
   - 讨论如何在合并报表时选择口径（策略维度 / 账户维度 / 品种维度）。
3. **加入延迟、滑点与成本模型**  
   - 在 Notebook 中增加可调的延迟 / 滑点参数，对比不同假设下的 PnL 曲线；  
   - 引导学生给出“理想收益 → 可实现收益”的折扣估算。
4. **将本实验升级为毕业项目主题之一**  
   - 要求学生在现有框架上，自主设计并实现一套「轻量级对账系统」；  
   - 输出包括：架构设计文档、实现代码、测试用例与风险分析。

> 建议：第一轮开课时，先稳定使用本 Lab 的 v1 版本；
> 后续如需加深难度，可直接从以上几点中挑选 1-2 个方向演进为新 Lab 或毕业项目题目。
