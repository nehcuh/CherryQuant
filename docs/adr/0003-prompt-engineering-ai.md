# ADR-0003: AI 策略 - 提示工程而非模型微调

## 状态
Accepted

## 背景

CherryQuant 的核心差异化特性是使用 AI（特别是大语言模型）进行交易决策。我们需要决定如何让 AI 理解期货市场并做出交易决策。

### 业务目标

- 实现"零样本"（zero-shot）交易决策能力
- 快速迭代和优化策略
- 降低 AI 模型的开发和维护成本
- 支持多品种、多策略的灵活配置

### 技术选项

1. **模型微调（Fine-tuning）**：使用历史数据微调 GPT 模型
2. **提示工程（Prompt Engineering）**：设计精良的提示词引导模型
3. **混合方法**：RAG（检索增强生成）+ 提示工程

### 约束条件

- 团队规模小，AI/ML 专家有限
- 需要快速验证想法
- 期货品种多样（黑色、有色、能化、农产品等）
- 市场环境变化快，需要灵活调整

## 决策

我们将采用 **提示工程（Prompt Engineering）** 作为主要的 AI 策略实现方式，而**不进行模型微调**。

### 核心方法

1. **精心设计的系统提示词**
   ```python
   SYSTEM_PROMPT = """
   你是一个专业的期货交易分析师，专注于中国期货市场。

   你的任务是基于提供的市场数据，做出交易决策。

   分析框架：
   1. 趋势分析：识别主要趋势（上涨/下跌/震荡）
   2. 动量分析：评估价格动量强度
   3. 风险评估：当前风险水平和潜在风险点
   4. 决策建议：BUY/SELL/HOLD，并说明理由和信心度

   输出格式（JSON）：
   {
       "action": "BUY/SELL/HOLD",
       "confidence": 0.0-1.0,
       "reasoning": "详细的分析理由",
       "risk_level": "LOW/MEDIUM/HIGH"
   }
   """
   ```

2. **动态用户提示词构建**
   ```python
   def build_user_prompt(symbol: str, data: dict) -> str:
       return f"""
       品种：{symbol}
       当前价格：{data['close']}
       24小时变化：{data['change_pct']}%

       技术指标：
       - MA5: {data['ma5']}
       - MA20: {data['ma20']}
       - RSI: {data['rsi']}
       - MACD: {data['macd']}

       请根据以上数据给出交易建议。
       """
   ```

3. **商品池配置驱动**
   - 不同商品类别使用不同的提示词模板
   - 通过 JSON 配置文件管理商品属性
   ```json
   {
       "rb": {
           "name": "螺纹钢",
           "sector": "黑色系",
           "characteristics": "受宏观经济和房地产影响大",
           "volatility": "中等"
       }
   }
   ```

4. **Few-shot 示例（可选）**
   - 在提示词中包含 2-3 个示例
   - 展示理想的分析和决策格式

### 不进行微调的原因

1. **成本和复杂度**
   - 微调需要大量高质量的标注数据
   - 需要 GPU 资源和 ML 专业知识
   - 维护成本高（模型版本管理、重新训练）

2. **灵活性**
   - 提示词可以实时调整，无需重新训练
   - 可以快速测试新的分析框架
   - 支持多品种的差异化策略

3. **泛化能力**
   - GPT-4 已经具备强大的推理能力
   - 提示工程可以利用模型的通用知识
   - 避免过拟合历史数据

## 考虑的备选方案

### 方案 A：GPT 微调（Fine-tuning）
**描述**：使用历史交易数据微调 GPT-3.5/4

**优点**：
- 模型更专业化，针对特定任务优化
- 可能提高预测准确性
- 减少提示词长度和 API 调用成本

**缺点**：
- 需要大量标注数据（数万条交易决策）
- 标注质量直接影响模型质量
- 微调成本高（时间和金钱）
- 需要定期重新训练（市场变化）
- 难以解释模型决策
- 缺乏灵活性

**为什么不选择**：
- 团队缺乏 ML 专业知识
- 获取高质量标注数据困难
- 市场环境变化快，模型容易过时
- 成本收益比不合理

### 方案 B：传统机器学习（XGBoost, LightGBM）
**描述**：使用传统 ML 模型进行交易决策

**优点**：
- 训练速度快
- 可解释性好（特征重要性）
- 成本低（不需要 API 调用）
- 成熟的工具和生态

**缺点**：
- 需要大量特征工程
- 难以处理非结构化信息（新闻、政策）
- 缺乏复杂推理能力
- 需要大量历史数据

**为什么不选择**：
- 不符合"AI 驱动"的项目愿景
- 缺乏 LLM 的灵活性和通用推理能力
- 特征工程工作量大
- 难以快速迭代策略

### 方案 C：RAG（检索增强生成）
**描述**：结合向量数据库检索历史相似情况 + GPT 生成

**优点**：
- 利用历史经验
- 提供上下文相关的决策
- 可以引用历史案例

**缺点**：
- 需要额外的向量数据库（Pinecone, Milvus）
- 增加系统复杂度
- 检索质量影响决策质量
- 实时性要求下延迟增加

**为什么不选择**：
- 增加架构复杂度
- 期货市场"历史不会简单重复"
- 可以作为未来优化方向，但不是当前必需

## 后果

### 正面影响

1. **快速迭代**
   - 修改提示词即可调整策略
   - 无需重新训练模型
   - 可以实时 A/B 测试不同提示词

2. **低成本启动**
   - 无需收集大量标注数据
   - 无需 GPU 资源
   - 开发周期短（周而非月）

3. **灵活性和可维护性**
   ```python
   # 轻松为不同商品定制策略
   SECTOR_SPECIFIC_PROMPTS = {
       "黑色系": "重点关注房地产和基建政策...",
       "有色金属": "关注全球供需和美元走势...",
       "能源化工": "分析原油价格和炼厂利润..."
   }
   ```

4. **可解释性**
   - AI 返回详细的推理过程
   - 便于理解和调试
   - 提高用户信任度

5. **利用 GPT 的通用能力**
   - 可以理解新闻事件影响
   - 具备常识推理
   - 跨领域知识迁移

### 负面影响

1. **API 调用成本**
   - 每次决策需要调用 GPT-4 API
   - 成本约 $0.03 - $0.06 per 1K tokens
   - **缓解措施**：
     - 使用缓存机制（相同输入返回缓存结果）
     - 批量处理，减少调用次数
     - 必要时降级到 GPT-3.5-turbo（成本降低 10x）

2. **延迟**
   - API 调用延迟 1-3 秒
   - 高频交易不适用
   - **缓解措施**：
     - 异步并发调用
     - 预测和缓存常见情况
     - 使用 streaming API 提前获取部分结果

3. **不确定性**
   - LLM 输出有一定随机性
   - 需要设置合理的 temperature 参数
   - **缓解措施**：
     - 使用低 temperature（0.2）提高一致性
     - 多次采样取平均（critical decisions）
     - 设置决策阈值，低信心度不执行

4. **提示词工程挑战**
   - 需要迭代优化提示词
   - 可能出现"提示词注入"等安全问题
   - **缓解措施**：
     - 建立提示词版本管理
     - 收集决策日志，分析改进
     - 输入验证和清洗

5. **对 OpenAI API 的依赖**
   - 服务中断会影响系统
   - API 变更可能影响功能
   - **缓解措施**：
     - 实现降级方案（基于规则的backup策略）
     - 监控 API 健康状态
     - 考虑支持多个 LLM 提供商（未来）

### 风险和缓解措施

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| API 成本超预算 | 中 | 中 | 设置预算告警，使用缓存，必要时降级 |
| 决策质量不稳定 | 中 | 高 | 低 temperature，决策日志分析，提示词优化 |
| API 服务中断 | 低 | 高 | 降级方案，多提供商支持（未来） |
| 提示词泄露商业秘密 | 低 | 中 | Code review，不在提示词中包含敏感信息 |

## 实施计划

1. ✅ **阶段 1：基础框架**（已完成）
   - 实现 `AsyncOpenAIClient`
   - 基础提示词模板
   - JSON 输出解析

2. ✅ **阶段 2：提示词优化**（已完成）
   - 设计系统提示词
   - 构建动态用户提示词
   - Few-shot 示例集成

3. **阶段 3：商品池配置**（进行中）
   - 建立商品属性数据库
   - 板块特定提示词模板
   - 配置驱动的策略选择

4. **阶段 4：优化和监控**（计划中）
   - 决策日志收集和分析
   - 提示词 A/B 测试框架
   - 成本和质量监控

5. **阶段 5：未来增强**（探索中）
   - RAG 集成（检索相似历史情况）
   - 多模型支持（Claude, Gemini）
   - 自动提示词优化

## 成功指标

- **决策一致性**：相同输入 95%+ 返回相同决策
- **成本控制**：月度 API 成本 < $500
- **响应时间**：95th percentile < 3s
- **降级可用性**：API 故障时系统仍可运行（基于规则）

## 参考资料

- [OpenAI Prompt Engineering Guide](https://platform.openai.com/docs/guides/prompt-engineering)
- [Prompt Engineering for Trading Systems](https://example.com/prompt-engineering-trading)
- [GPT-4 vs Fine-tuning: When to Choose Which](https://example.com/gpt4-vs-finetuning)
- [LangChain Prompting Best Practices](https://python.langchain.com/docs/modules/prompts/)
- [Team Decision Discussion Thread](链接到内部讨论)

## 变更历史

- 2025-09-01: 初始决策文档（CherryQuant Team）
- 2025-09-15: 添加 Few-shot 示例策略（CherryQuant Team）
- 2025-10-01: 完成基础实现，状态更改为 Accepted（CherryQuant Team）
- 2025-11-18: 添加到 ADR 系统，更新实施进展（CherryQuant Team）
