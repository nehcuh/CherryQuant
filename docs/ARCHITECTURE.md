# CherryQuant 系统架构文档

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CherryQuant 系统架构                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                              用户接口层                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ run_cherry │  │   run_     │  │    run_    │  │   Web API  │           │
│  │  quant.py  │  │ complete.py│  │ai_select.py│  │  (FastAPI) │           │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘           │
└──────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            核心业务层                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │               AI 决策引擎 (AI Decision Engine)                   │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  ┌──────────────────┐         ┌──────────────────────┐         │        │
│  │  │ AISelectionEngine│◄───────►│  FuturesEngine       │         │        │
│  │  │ (品种选择)        │         │  (交易决策)           │         │        │
│  │  └──────────────────┘         └──────────────────────┘         │        │
│  │           │                              │                      │        │
│  │           ▼                              ▼                      │        │
│  │  ┌──────────────────────────────────────────────────┐          │        │
│  │  │        OpenAI GPT-4 / Claude                    │          │        │
│  │  │        (LLM Client)                              │          │        │
│  │  └──────────────────────────────────────────────────┘          │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │              多策略代理系统 (Multi-Agent System)                 │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │        │
│  │  │ AgentManager │  │ StrategyAgent│  │ StrategyAgent│         │        │
│  │  │  (协调器)     │──┤  (趋势跟踪)   │  │  (均值回归)   │  ...    │        │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                风险管理 (Risk Management)                        │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  ┌──────────────────┐         ┌──────────────────────┐         │        │
│  │  │ RiskManager      │         │  AlertManager        │         │        │
│  │  │ (风险控制)        │         │  (告警系统)           │         │        │
│  │  └──────────────────┘         └──────────────────────┘         │        │
│  └─────────────────────────────────────────────────────────────────┘        │
└──────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            数据适配层                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │              市场数据管理 (Market Data Management)               │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  ┌──────────────────┐         ┌──────────────────────┐         │        │
│  │  │MarketDataManager │         │ ContractResolver     │         │        │
│  │  │(多数据源)         │         │ (主力合约解析)        │         │        │
│  │  └──────────────────┘         └──────────────────────┘         │        │
│  │           │                              │                      │        │
│  │           │                              │                      │        │
│  │  ┌────────┴────────┐           ┌────────┴────────┐             │        │
│  │  │  RealtimeRecorder│           │ HistoryDataMgr  │             │        │
│  │  │  (实时K线聚合)   │           │ (历史数据管理)   │             │        │
│  │  └─────────────────┘           └─────────────────┘             │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                交易执行 (Trade Execution)                        │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  ┌──────────────────┐         ┌──────────────────────┐         │        │
│  │  │  VNPyGateway     │         │  OrderManager        │         │        │
│  │  │  (CTP网关封装)    │         │  (订单管理)           │         │        │
│  │  └──────────────────┘         └──────────────────────┘         │        │
│  └─────────────────────────────────────────────────────────────────┘        │
└──────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            数据存储层                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │   PostgreSQL   │  │     Redis      │  │   本地缓存      │               │
│  │  (TimescaleDB) │  │   (实时缓存)    │  │   (SQLite)     │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
└──────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           外部服务层                                           │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   OpenAI    │  │  Tushare Pro│  │   vnpy CTP  │  │   AKShare   │        │
│  │    API      │  │     API     │  │   Gateway   │  │     API     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 数据流程图

### 1. 实时交易数据流（Live模式）

```
CTP交易所
    │ Tick数据
    ▼
┌──────────────┐
│ VNPyGateway  │
│ (CTP连接)    │
└──────┬───────┘
       │ Tick回调
       ▼
┌───────────────────┐
│ RealtimeRecorder  │
│ (Tick→K线聚合)     │
└─────────┬─────────┘
          │ 5m/10m/30m/60m K线
          ▼
┌────────────────────┐        ┌─────────────────┐
│ TimescaleDB        │◄───────│  Redis缓存      │
│ (时序数据)          │        │  (最新价格)      │
└──────┬─────────────┘        └─────────────────┘
       │ 查询历史数据
       ▼
┌──────────────────────┐
│ AI Decision Engine   │
│ (GPT-4分析决策)       │
└──────┬───────────────┘
       │ 交易信号
       ▼
┌──────────────────────┐
│  Order Manager       │
│  (订单生成)           │
└──────┬───────────────┘
       │ CTP订单
       ▼
┌──────────────────────┐
│   VNPyGateway        │
│   (订单发送)          │
└──────┬───────────────┘
       │
       ▼
    CTP交易所
```

### 2. 品种选择流程（AI Selection）

```
strategies.json
    │ 品种池配置
    │ {"commodity_pool": "black",
    │  "commodities": ["rb", "hc", "i", "j", "jm"]}
    ▼
┌─────────────────────┐
│ ContractResolver    │
│ (主力合约解析)       │
└──────┬──────────────┘
       │ Tushare fut_mapping API
       │ rb → rb2501
       │ hc → hc2501
       ▼
┌─────────────────────────┐
│ MarketDataManager       │
│ (获取各合约行情)         │
└──────┬──────────────────┘
       │ 技术指标计算
       │ RSI, MA, 趋势强度等
       ▼
┌─────────────────────────┐
│ AISelectionEngine       │
│ (GPT-4品种选择)         │
└──────┬──────────────────┘
       │ 选择最优合约
       │ {"symbol": "rb2501",
       │  "confidence": 0.85}
       ▼
┌─────────────────────────┐
│ FuturesEngine           │
│ (具体交易决策)           │
└─────────────────────────┘
```

### 3. 多策略协调流程

```
┌─────────────────────┐
│  AgentManager       │
│  (策略协调器)        │
└──────┬──────────────┘
       │ 加载strategies.json
       │
       ├───► StrategyAgent 1 (趋势跟踪, 黑色系池)
       │     └──► 品种解析: [rb2501, hc2501, i2501]
       │          └──► AI决策: 做多rb2501
       │
       ├───► StrategyAgent 2 (均值回归, 有色金属池)
       │     └──► 品种解析: [cu2412, al2501]
       │          └──► AI决策: 持币观望
       │
       └───► StrategyAgent 3 (突破策略, 贵金属池)
             └──► 品种解析: [au2506, ag2506]
                  └──► AI决策: 做空ag2506
```

## 核心组件说明

### 1. ContractResolver (主力合约解析器)
**路径**: `adapters/data_adapter/contract_resolver.py`

**功能**:
- 使用Tushare `fut_mapping` API查询主力合约
- 批量解析多个品种的当前主力合约
- 缓存机制（1小时TTL）减少API调用
- 降级方案：Tushare失败时使用规则推算

**示例**:
```python
resolver = get_contract_resolver(tushare_token)
contracts = await resolver.batch_resolve_contracts(["rb", "cu", "IF"])
# 返回: {"rb": "rb2501", "cu": "cu2412", "IF": "IF2412"}
```

### 2. AISelectionEngine (AI品种选择引擎)
**路径**: `ai/decision_engine/ai_selection_engine.py`

**功能**:
- 从品种池中分析并选择最优交易机会
- 集成ContractResolver动态解析主力合约
- 支持全市场扫描或限定品种池
- GPT-4驱动的多因子评分

**流程**:
1. 解析品种池 → 获取主力合约
2. 获取各合约行情和技术指标
3. 构造AI提示词（市场数据+账户状态）
4. GPT-4分析并返回交易决策

### 3. VNPyGateway (CTP网关封装)
**路径**: `src/trading/vnpy_gateway.py`

**功能**:
- 封装vnpy的MainEngine和CtpGateway
- 正确的API使用：`add_gateway(CtpGateway)`
- 订阅请求：`SubscribeRequest(symbol, exchange)`
- 连接状态跟踪和事件处理

**关键修复**:
- ✅ `initialize()`: 传入Gateway类而非字符串
- ✅ `subscribe()`: 使用SubscribeRequest对象
- ✅ 异步等待连接建立

### 4. RealtimeRecorder (实时数据记录器)
**路径**: `adapters/vnpy_recorder/realtime_recorder.py`

**功能**:
- 订阅CTP Tick数据
- 聚合为5m/10m/30m/60m K线
- 写入PostgreSQL (TimescaleDB)

### 5. MarketDataManager (市场数据管理器)
**路径**: `adapters/data_adapter/market_data_manager.py`

**功能**:
- 多数据源管理（Tushare, AKShare, 数据库）
- 数据源降级策略
- 支持双模式：
  - **live**: 从数据库读取CTP实时数据
  - **dev**: 使用AKShare准实时数据

## 配置管理

### 品种池配置 (config/strategies.json)

```json
{
  "commodity_pools": {
    "black": {
      "name": "黑色系",
      "commodities": ["rb", "hc", "i", "j", "jm"]
    }
  },
  "strategies": [
    {
      "strategy_id": "trend_following_01",
      "commodity_pool": "black",
      "max_symbols": 3,
      "selection_mode": "ai_driven"
    }
  ]
}
```

### 环境配置 (.env)

**关键配置项**:
- `DATA_MODE`: live(CTP实时) | dev(AKShare准实时)
- `TUSHARE_TOKEN`: Tushare Pro令牌（2000+积分）
- `CTP_USERID`, `CTP_PASSWORD`: CTP账户（live模式必需）
- `OPENAI_API_KEY`: OpenAI API密钥

## 部署架构

### 开发环境（dev模式）
```
开发机器
├── Python应用 (run_cherryquant.py)
├── PostgreSQL (本地或Docker)
├── Redis (本地或Docker)
└── 数据源: AKShare (免费API)
```

### 生产环境（live模式）
```
云服务器 / 本地服务器
├── Python应用 (run_cherryquant_complete.py)
├── PostgreSQL (TimescaleDB)
├── Redis
├── CTP连接 (模拟盘 SimNow 或 实盘)
├── 数据源: Tushare Pro (2000+积分)
└── Web API (可选，监控面板)
```

## 技术栈

**后端**:
- Python 3.12+
- vnpy 4.1.0+ (CTP网关)
- OpenAI GPT-4 (AI决策)
- Tushare Pro (数据源)
- Pydantic (配置验证)

**数据**:
- PostgreSQL + TimescaleDB (时序数据)
- Redis (实时缓存)
- SQLite (本地缓存)

**Web**:
- FastAPI (REST API)
- WebSocket (实时推送)

## 最佳实践

1. **首次运行**: 使用`DATA_MODE=dev`测试
2. **品种选择**: 配置品种池，让AI自主选择
3. **风险控制**: 设置合理的`max_position_size`和`risk_per_trade`
4. **数据积分**: Tushare Pro分钟线需要2000+积分
5. **CTP连接**: 先用SimNow模拟盘测试
6. **日志监控**: 定期查看logs目录下的日志文件

## 后续扩展

- [ ] 多账户支持（实盘+模拟盘并行）
- [ ] 实时止损止盈跟踪
- [ ] 回测系统集成
- [ ] 更多AI模型支持（Claude, 国产大模型）
- [ ] 移动端监控APP
- [ ] 策略市场（策略分享和订阅）
