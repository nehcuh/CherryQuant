<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ CherryQuant - AIæœŸè´§äº¤æ˜“ç³»ç»Ÿç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card.positive .value {
            color: #10b981;
        }

        .stat-card.negative .value {
            color: #ef4444;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .strategy-list {
            display: grid;
            gap: 15px;
        }

        .strategy-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
        }

        .strategy-item:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .strategy-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-badge.idle {
            background: #e5e7eb;
            color: #6b7280;
        }

        .status-badge.trading {
            background: #d1fae5;
            color: #065f46;
        }

        .strategy-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .metric .label {
            color: #666;
        }

        .metric .value {
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
        }

        .footer a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .footer a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .refresh-info {
            color: #666;
            font-size: 0.9em;
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’ CherryQuant</h1>
            <div class="subtitle">AIé©±åŠ¨çš„æœŸè´§äº¤æ˜“ç³»ç»Ÿå®æ—¶ç›‘æ§</div>
        </div>

        <div class="stats-grid" id="stats">
            <div class="loading">æ­£åœ¨åŠ è½½ç³»ç»ŸçŠ¶æ€...</div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ ç­–ç•¥çŠ¶æ€</h2>
            <div class="strategy-list" id="strategies">
                <div class="loading">æ­£åœ¨åŠ è½½ç­–ç•¥ä¿¡æ¯...</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
            <div id="system-info">
                <div class="loading">æ­£åœ¨åŠ è½½ç³»ç»Ÿä¿¡æ¯...</div>
            </div>
            <div class="refresh-info">
                æ•°æ®æ¯5ç§’è‡ªåŠ¨åˆ·æ–° | æœ€åæ›´æ–°: <span id="last-update">-</span>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ¯ ç­–ç•¥æ‰§è¡Œå¯¹æ¯”ï¼ˆæ¨¡æ‹Ÿ vs å®ç›˜ï¼‰</h2>
            <div id="execution-compare">
                <div class="loading">ç‚¹å‡»ä¸Šæ–¹ä»»æ„ç­–ç•¥å¡ç‰‡ï¼ŒæŸ¥çœ‹è¯¥ç­–ç•¥çš„æ¨¡æ‹Ÿäº¤æ˜“ä¸å®ç›˜æ‰§è¡Œç»Ÿè®¡...</div>
            </div>
        </div>

        <div class="footer">
            <a href="/docs" target="_blank">ğŸ“– API æ–‡æ¡£</a>
            <a href="/api/v1/status" target="_blank">ğŸ” ç³»ç»ŸçŠ¶æ€ API</a>
            <a href="https://github.com/your-username/CherryQuant" target="_blank">ğŸ’» GitHub</a>
        </div>
    </div>

    <script>
        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString('zh-CN', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
        function formatPercent(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            const sign = num >= 0 ? '+' : '';
            return sign + num.toFixed(decimals) + '%';
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/v1/status');
                const data = await response.json();

                const system = data.system;
                const statsHtml = `
                    <div class="stat-card">
                        <div class="label">ç»„åˆæ€»ä»·å€¼</div>
                        <div class="value">Â¥${formatNumber(system.portfolio_value, 0)}</div>
                    </div>
                    <div class="stat-card ${system.total_pnl >= 0 ? 'positive' : 'negative'}">
                        <div class="label">æ€»ç›ˆäº</div>
                        <div class="value">${formatPercent(system.portfolio_return)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">æ´»è·ƒç­–ç•¥</div>
                        <div class="value">${system.active_strategies}/${system.total_strategies}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">æ€»äº¤æ˜“æ•°</div>
                        <div class="value">${system.total_trades}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">èµ„é‡‘ä½¿ç”¨ç‡</div>
                        <div class="value">${formatPercent(system.capital_usage * 100, 1)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">æ—¥ç›ˆäº</div>
                        <div class="value ${system.daily_pnl >= 0 ? 'positive' : 'negative'}">
                            Â¥${formatNumber(system.daily_pnl, 0)}
                        </div>
                    </div>
                `;

                document.getElementById('stats').innerHTML = statsHtml;

            } catch (error) {
                document.getElementById('stats').innerHTML =
                    '<div class="error">âš ï¸ æ— æ³•åŠ è½½ç³»ç»ŸçŠ¶æ€: ' + error.message + '</div>';
            }
        }

        // åŠ è½½ç­–ç•¥åˆ—è¡¨
        async function loadStrategies() {
            try {
                const response = await fetch('/api/v1/strategies');
                const data = await response.json();

                if (data.strategies.length === 0) {
                    document.getElementById('strategies').innerHTML =
                        '<div class="loading">æš‚æ— è¿è¡Œä¸­çš„ç­–ç•¥</div>';
                    return;
                }

                const strategiesHtml = data.strategies.map(strategy => `
                    <div class="strategy-item" data-strategy-id="${strategy.strategy_id}">
                        <div class="strategy-header">
                            <span class="strategy-name">${strategy.name}</span>
                            <span class="status-badge ${strategy.status}">${strategy.status}</span>
                        </div>
                        <div class="strategy-metrics">
                            <div class="metric">
                                <span class="label">è´¦æˆ·ä»·å€¼:</span>
                                <span class="value">Â¥${formatNumber(strategy.account_value, 0)}</span>
                            </div>
                            <div class="metric">
                                <span class="label">æ”¶ç›Šç‡:</span>
                                <span class="value" style="color: ${strategy.return_pct >= 0 ? '#10b981' : '#ef4444'}">
                                    ${formatPercent(strategy.return_pct)}
                                </span>
                            </div>
                            <div class="metric">
                                <span class="label">äº¤æ˜“æ•°:</span>
                                <span class="value">${strategy.total_trades}</span>
                            </div>
                            <div class="metric">
                                <span class="label">èƒœç‡:</span>
                                <span class="value">${formatPercent(strategy.win_rate * 100, 1)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('strategies').innerHTML = strategiesHtml;

                attachStrategyClickHandlers();

            } catch (error) {
                document.getElementById('strategies').innerHTML =
                    '<div class="error">âš ï¸ æ— æ³•åŠ è½½ç­–ç•¥ä¿¡æ¯: ' + error.message + '</div>';
            }
        }

        async function loadStrategyExecutions(strategyId) {
            const container = document.getElementById('execution-compare');
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç­–ç•¥æ‰§è¡Œä¿¡æ¯...</div>';

            try {
                const resp = await fetch(`/api/v1/strategies/${strategyId}/executions`);
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                const data = await resp.json();
                const sim = data.recent_trades || [];
                const live = data.live_executions || [];
                const simPnlLast = data.sim_pnl_last;
                const livePnlLast = data.live_pnl_last;
                const pnlDiff = data.pnl_diff;

                const diffColor = pnlDiff == null ? '#4b5563' : (pnlDiff >= 0 ? '#10b981' : '#ef4444');

                const html = `
                    <div class="strategy-metrics">
                        <div class="metric">
                            <span class="label">ç­–ç•¥ ID:</span>
                            <span class="value">${data.strategy_id}</span>
                        </div>
                        <div class="metric">
                            <span class="label">æ¨¡æ‹Ÿäº¤æ˜“ç¬”æ•° (recent_trades):</span>
                            <span class="value">${sim.length}</span>
                        </div>
                        <div class="metric">
                            <span class="label">å®ç›˜æ‰§è¡Œç¬”æ•° (live_executions):</span>
                            <span class="value">${live.length}</span>
                        </div>
                        <div class="metric">
                            <span class="label">æ¨¡æ‹Ÿç´¯è®¡ PnL:</span>
                            <span class="value">${simPnlLast == null ? '-' : formatNumber(simPnlLast, 0)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">å®ç›˜ç´¯è®¡ PnL:</span>
                            <span class="value">${livePnlLast == null ? '-' : formatNumber(livePnlLast, 0)}</span>
                        </div>
                        <div class="metric">
                            <span class="label">PnL å·®å€¼ (å®ç›˜ - æ¨¡æ‹Ÿ):</span>
                            <span class="value" style="color: ${diffColor};">
                                ${pnlDiff == null ? '-' : formatNumber(pnlDiff, 0)}
                            </span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #4b5563;">
                        <strong>æœ€è¿‘æ¨¡æ‹Ÿäº¤æ˜“ï¼š</strong><br/>
                        ${sim.slice(-3).map(t => `
                            Â· ${t.timestamp || t.entry_time || '-'} | ${t.symbol} | ${t.direction || '-'} | æ•°é‡: ${t.quantity || '-'}
                        `).join('<br/>') || '(æ— è®°å½•)'}
                        <br/><br/>
                        <strong>æœ€è¿‘å®ç›˜æ‰§è¡Œï¼š</strong><br/>
                        ${live.slice(-3).map(e => `
                            Â· ${e.timestamp || '-'} | ${e.symbol || '-'} | ${e.direction || '-'} | æ•°é‡: ${e.volume || '-'} @ ${e.price || '-'}
                        `).join('<br/>') || '(æ— è®°å½•)'}
                    </div>
                    <div style="margin-top: 12px; display: flex; align-items: center; gap: 12px; font-size: 0.85em; color: #4b5563;">
                        <label>æ—¶é—´èŒƒå›´:
                            <select id="pnl-range-select" style="margin-left: 4px; padding: 2px 6px; font-size: 0.85em;">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="30m">æœ€è¿‘ 30 åˆ†é’Ÿ</option>
                                <option value="2h">æœ€è¿‘ 2 å°æ—¶</option>
                                <option value="1d">æœ€è¿‘ 1 å¤©</option>
                            </select>
                        </label>
                        <label><input type="checkbox" id="pnl-show-sim" checked> æ˜¾ç¤ºæ¨¡æ‹Ÿ PnL</label>
                        <label><input type="checkbox" id="pnl-show-live" checked> æ˜¾ç¤ºå®ç›˜ PnL</label>
                    </div>
                    <div id="pnl-chart" style="margin-top: 8px;"></div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #6b7280;">
                        æç¤ºï¼šæ¨¡æ‹Ÿäº¤æ˜“æ¥è‡ª StrategyAgent å†…éƒ¨è´¦æœ¬ï¼Œå®ç›˜æ‰§è¡Œæ¥è‡ª KLineOrderManager çš„è®¢å•å›æŠ¥ï¼Œ
                        ä¸¤è€…æ•°é‡å’Œæ—¶é—´å¯èƒ½å­˜åœ¨å·®å¼‚ï¼Œå¯ç”¨äºè¯¾å ‚è®¨è®ºâ€œæ¨¡å‹é¢„æœŸ vs å¸‚åœºå®é™…â€ã€‚
                    </div>
                `;

                container.innerHTML = html;
                setupPnlControls(data.sim_pnl || [], data.live_pnl || []);
            } catch (error) {
                container.innerHTML = '<div class="error">âš ï¸ æ— æ³•åŠ è½½ç­–ç•¥æ‰§è¡Œä¿¡æ¯: ' + error.message + '</div>';
            }
        }

        let currentPnlData = { sim: [], live: [] };
        let currentPnlOptions = { range: 'all', showSim: true, showLive: true };

        function attachStrategyClickHandlers() {
            const items = document.querySelectorAll('.strategy-item');
            items.forEach(item => {
                item.addEventListener('click', () => {
                    const strategyId = item.getAttribute('data-strategy-id');
                    if (strategyId) {
                        loadStrategyExecutions(strategyId);
                    }
                });
            });
        }

        function setupPnlControls(simPnl, livePnl) {
            currentPnlData = { sim: simPnl || [], live: livePnl || [] };
            currentPnlOptions = { range: 'all', showSim: true, showLive: true };

            const rangeSelect = document.getElementById('pnl-range-select');
            const cbSim = document.getElementById('pnl-show-sim');
            const cbLive = document.getElementById('pnl-show-live');

            if (!rangeSelect || !cbSim || !cbLive) {
                renderPnlChart();
                return;
            }

            rangeSelect.value = 'all';
            cbSim.checked = true;
            cbLive.checked = true;

            rangeSelect.onchange = () => {
                currentPnlOptions.range = rangeSelect.value;
                renderPnlChart();
            };
            cbSim.onchange = () => {
                currentPnlOptions.showSim = cbSim.checked;
                renderPnlChart();
            };
            cbLive.onchange = () => {
                currentPnlOptions.showLive = cbLive.checked;
                renderPnlChart();
            };

            renderPnlChart();
        }

        function renderPnlChart(simPnl, livePnl) {
            if (simPnl !== undefined && livePnl !== undefined) {
                // å…è®¸åœ¨é¦–æ¬¡è°ƒç”¨æ—¶ç›´æ¥ä¼ å…¥æ•°æ®
                currentPnlData = { sim: simPnl || [], live: livePnl || [] };
                currentPnlOptions = { range: 'all', showSim: true, showLive: true };
            }

            const container = document.getElementById('pnl-chart');
            if (!container) return;

            const hasSim = Array.isArray(currentPnlData.sim) && currentPnlData.sim.length > 0;
            const hasLive = Array.isArray(currentPnlData.live) && currentPnlData.live.length > 0;
            if (!hasSim && !hasLive) {
                container.innerHTML = '<div class="loading">æš‚æ—¶æ²¡æœ‰ PnL æ›²çº¿æ•°æ®</div>';
                return;
            }

            function normalize(series) {
                return (series || []).map(p => {
                    const t = new Date(p.timestamp).getTime();
                    const v = Number(p.cum_pnl || 0);
                    if (isNaN(t) || isNaN(v)) return null;
                    return { t, v };
                }).filter(Boolean);
            }

            // å½’ä¸€åŒ–å¹¶åº”ç”¨æ—¶é—´çª—å£ & æ˜¾ç¤ºå¼€å…³
            let sim = hasSim && currentPnlOptions.showSim ? normalize(currentPnlData.sim) : [];
            let live = hasLive && currentPnlOptions.showLive ? normalize(currentPnlData.live) : [];

            // åº”ç”¨æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼ˆåŸºäºæœ€æ–°æ—¶é—´ç‚¹ï¼‰
            const combined = sim.concat(live);
            if (combined.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ—¶æ²¡æœ‰ PnL æ›²çº¿æ•°æ®</div>';
                return;
            }

            const maxGlobalT = Math.max.apply(null, combined.map(p => p.t));
            let windowMs = null;
            if (currentPnlOptions.range === '30m') {
                windowMs = 30 * 60 * 1000;
            } else if (currentPnlOptions.range === '2h') {
                windowMs = 2 * 60 * 60 * 1000;
            } else if (currentPnlOptions.range === '1d') {
                windowMs = 24 * 60 * 60 * 1000;
            }
            if (windowMs !== null) {
                const cutoff = maxGlobalT - windowMs;
                sim = sim.filter(p => p.t >= cutoff);
                live = live.filter(p => p.t >= cutoff);
            }

            if (sim.length === 0 && live.length === 0) {
                container.innerHTML = '<div class="loading">æ‰€é€‰æ—¶é—´èŒƒå›´å†…æš‚æ—  PnL æ•°æ®</div>';
                return;
            }

            const all = sim.concat(live);
            if (sim.length === 0 && live.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ—¶æ²¡æœ‰ PnL æ›²çº¿æ•°æ®</div>';
                return;
            }

            const all = sim.concat(live);
            let minT = Math.min.apply(null, all.map(p => p.t));
            let maxT = Math.max.apply(null, all.map(p => p.t));
            let minV = Math.min.apply(null, all.map(p => p.v));
            let maxV = Math.max.apply(null, all.map(p => p.v));

            if (minT === maxT) {
                minT -= 60 * 1000;
                maxT += 60 * 1000;
            }
            if (minV === maxV) {
                minV -= 1;
                maxV += 1;
            }

            const w = 400;
            const h = 120;
            const pad = 20;

            function buildPath(series) {
                if (!series || series.length === 0) return '';
                return series.map((p, idx) => {
                    const xRatio = (p.t - minT) / (maxT - minT || 1);
                    const yRatio = (p.v - minV) / (maxV - minV || 1);
                    const x = pad + xRatio * (w - 2 * pad);
                    const y = (h - pad) - yRatio * (h - 2 * pad);
                    return (idx === 0 ? 'M' : 'L') + x.toFixed(1) + ' ' + y.toFixed(1);
                }).join(' ');
            }

            const simPath = buildPath(sim);
            const livePath = buildPath(live);

            const svg = `
                <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
                    <rect x="0" y="0" width="${w}" height="${h}" fill="#f9fafb" />
                    <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#e5e7eb" stroke-width="1" />
                    ${simPath ? `<path d="${simPath}" fill="none" stroke="#3b82f6" stroke-width="1.8" />` : ''}
                    ${livePath ? `<path d="${livePath}" fill="none" stroke="#f97316" stroke-width="1.8" />` : ''}
                    <text x="${pad}" y="${pad}" fill="#4b5563" font-size="10">Sim PnL</text>
                    <text x="${pad + 70}" y="${pad}" fill="#4b5563" font-size="10">Live PnL</text>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/v1/health');
                const data = await response.json();

                const infoHtml = `
                    <div class="strategy-metrics">
                        <div class="metric">
                            <span class="label">ç³»ç»ŸçŠ¶æ€:</span>
                            <span class="value" style="color: ${data.status === 'healthy' ? '#10b981' : '#ef4444'}">
                                ${data.status === 'healthy' ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}
                            </span>
                        </div>
                        <div class="metric">
                            <span class="label">ä»£ç†ç®¡ç†å™¨:</span>
                            <span class="value">${data.services.agent_manager ? 'âœ…' : 'âŒ'}</span>
                        </div>
                        <div class="metric">
                            <span class="label">æ•°æ®åº“:</span>
                            <span class="value">${data.services.database ? 'âœ…' : 'âŒ'}</span>
                        </div>
                        <div class="metric">
                            <span class="label">AIæ—¥å¿—:</span>
                            <span class="value">${data.services.ai_logger ? 'âœ…' : 'âŒ'}</span>
                        </div>
                    </div>
                `;

                document.getElementById('system-info').innerHTML = infoHtml;

            } catch (error) {
                document.getElementById('system-info').innerHTML =
                    '<div class="error">âš ï¸ æ— æ³•åŠ è½½ç³»ç»Ÿä¿¡æ¯: ' + error.message + '</div>';
            }
        }

        // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
        function updateLastRefresh() {
            const now = new Date();
            document.getElementById('last-update').textContent =
                now.toLocaleTimeString('zh-CN');
        }

        // åˆå§‹åŒ–å’Œå®šæ—¶åˆ·æ–°
        async function refresh() {
            await Promise.all([
                loadSystemStatus(),
                loadStrategies(),
                loadSystemInfo()
            ]);
            updateLastRefresh();
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        refresh();

        // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(refresh, 5000);
    </script>
</body>
</html>
