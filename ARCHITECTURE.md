# CherryQuant 系统架构文档

## 📐 业务架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CherryQuant AI 期货交易系统                          │
└─────────────────────────────────────────────────────────────────────────────┘

                                   ┌──────────────┐
                                   │   用户界面    │
                                   └──────┬───────┘
                                          │
                ┌─────────────────────────┼─────────────────────────┐
                │                         │                         │
                ▼                         ▼                         ▼
        ┌───────────────┐         ┌─────────────┐         ┌──────────────┐
        │  Web Dashboard│         │  REST API   │         │   命令行工具  │
        │   (前端界面)   │         │  (HTTP接口) │         │   (CLI控制)   │
        └───────┬───────┘         └──────┬──────┘         └──────┬───────┘
                │                        │                        │
                └────────────────────────┼────────────────────────┘
                                         │
                        ┌────────────────┴────────────────┐
                        │        核心业务层 (Core)          │
                        └────────────────┬────────────────┘
                                         │
        ┌────────────────────────────────┼────────────────────────────────┐
        │                                │                                │
        ▼                                ▼                                ▼
┌───────────────┐              ┌──────────────────┐            ┌──────────────┐
│  多代理管理器  │              │   AI 决策引擎     │            │  风险管理器   │
│ (AgentManager)│◄─────────────┤ (DecisionEngine) │───────────►│(RiskManager) │
└───────┬───────┘              └────────┬─────────┘            └──────┬───────┘
        │                               │                              │
        │ 管理                          │ 调用                         │ 监控
        ▼                               ▼                              ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                           5个并行运行的策略代理                             │
├───────────────┬───────────────┬──────────────┬──────────────┬─────────────┤
│ 趋势跟踪策略   │ 均值回归策略   │  突破策略    │   套利策略   │跨板块AI策略  │
│  (黑色系)     │  (有色金属)   │  (贵金属)    │  (黑色系)    │ (全市场42品种)│
└───────┬───────┴───────┬───────┴──────┬───────┴──────┬───────┴─────┬───────┘
        │               │              │              │             │
        └───────────────┴──────────────┴──────────────┴─────────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        │       交易执行层              │
                        └──────────────┬──────────────┘
                                       │
        ┌──────────────────────────────┼──────────────────────────────┐
        │                              │                              │
        ▼                              ▼                              ▼
┌───────────────┐            ┌──────────────────┐          ┌──────────────┐
│ 订单管理系统   │            │   持仓管理系统    │          │   警报系统    │
│(OrderManager) │            │(PositionManager) │          │(AlertManager)│
└───────┬───────┘            └────────┬─────────┘          └──────┬───────┘
        │                             │                            │
        └─────────────────────────────┼────────────────────────────┘
                                      │
                        ┌─────────────┴─────────────┐
                        │       数据接入层           │
                        └─────────────┬─────────────┘
                                      │
        ┌─────────────────────────────┼─────────────────────────────┐
        │                             │                             │
        ▼                             ▼                             ▼
┌───────────────┐            ┌──────────────────┐        ┌──────────────┐
│  CTP实时数据   │            │   Tushare历史     │        │  QuantBox    │
│  (VNPy网关)   │            │   (Tushare API)  │        │  (期货数据)   │
└───────────────┘            └──────────────────┘        └──────────────┘
        │                             │                             │
        └─────────────────────────────┼─────────────────────────────┘
                                      │
                        ┌─────────────▼─────────────┐
                        │       存储层               │
                        ├───────────────────────────┤
                        │  MongoDB (时间序列)        │
                        │  Redis (缓存)             │
                        └───────────────────────────┘
```

---

## 🏗️ 技术架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             应用层 (Application Layer)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────┐    ┌────────────────────┐    ┌──────────────────┐  │
│  │   Web Frontend     │    │    FastAPI App     │    │   CLI Tools      │  │
│  │   (React/Vue)      │    │   (Uvicorn ASGI)   │    │   (Click/Typer)  │  │
│  │   Port: 3000       │    │   Port: 8000       │    │                  │  │
│  └────────┬───────────┘    └─────────┬──────────┘    └────────┬─────────┘  │
│           │                          │                         │            │
│           └──────────────────────────┼─────────────────────────┘            │
│                                      │                                      │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
                                       │ HTTP/WebSocket
                                       │
┌──────────────────────────────────────▼──────────────────────────────────────┐
│                           业务逻辑层 (Business Logic Layer)                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                        多代理协调系统                                   │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐         │  │
│  │  │ Strategy Agent │  │ Strategy Agent │  │ Strategy Agent │  ...    │  │
│  │  │   (Asyncio)    │  │   (Asyncio)    │  │   (Asyncio)    │         │  │
│  │  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘         │  │
│  │           │                   │                   │                  │  │
│  │           └───────────────────┼───────────────────┘                  │  │
│  └───────────────────────────────┼──────────────────────────────────────┘  │
│                                  │                                         │
│  ┌───────────────────────────────▼──────────────────────────────────────┐  │
│  │                         AI 决策引擎                                    │  │
│  │  ┌─────────────────┐    ┌──────────────────┐    ┌────────────────┐  │  │
│  │  │  OpenAI Client  │    │  GLM-4 Client    │    │  Prompt Manager│  │  │
│  │  │  (gpt-4)        │    │  (智谱AI)         │    │  (模板管理)     │  │  │
│  │  └─────────────────┘    └──────────────────┘    └────────────────┘  │  │
│  └───────────────────────────────┬──────────────────────────────────────┘  │
│                                  │                                         │
│  ┌───────────────────────────────▼──────────────────────────────────────┐  │
│  │                       风险管理系统                                      │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │  │
│  │  │ 仓位风险控制  │  │ 止损止盈管理  │  │ 实时监控预警  │              │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────┬───────────────────────────────────────┘
                                       │
┌──────────────────────────────────────▼──────────────────────────────────────┐
│                           数据访问层 (Data Access Layer)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      DatabaseManager (异步)                           │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  MongoDB Manager                                               │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐     │  │  │
│  │  │  │ Motor Client │  │ Time Series  │  │ Connection Pool  │     │  │  │
│  │  │  │ (Async I/O)  │  │ Collections  │  │ (5-50 connections)│     │  │  │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────┘     │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                       │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Redis Manager                                                 │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐     │  │  │
│  │  │  │ aioredis     │  │ Cache Layer  │  │ Session Storage  │     │  │  │
│  │  │  │ (Async)      │  │ (5min TTL)   │  │                  │     │  │  │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────┘     │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    MarketDataManager (市场数据)                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐        │  │
│  │  │ Live Mode:   │  │ Dev Mode:    │  │ RealtimeRecorder     │        │  │
│  │  │ CTP Tick     │  │ Tushare API  │  │ (Tick→5m/10m/30m/1H) │        │  │
│  │  │ (VNPy)       │  │ (QuantBox)   │  │                      │        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────┬───────────────────────────────────────┘
                                       │
┌──────────────────────────────────────▼──────────────────────────────────────┐
│                         外部服务层 (External Services Layer)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   VNPy CTP   │  │  Tushare Pro │  │   OpenAI API │  │   GLM-4 API  │   │
│  │   Gateway    │  │   (QuantBox) │  │              │  │   (智谱AI)    │   │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤  ├──────────────┤   │
│  │ • 实时Tick   │  │ • 历史数据   │  │ • GPT-4决策  │  │ • GLM-4决策  │   │
│  │ • 委托下单   │  │ • 合约信息   │  │ • 文本分析   │  │ • 策略生成   │   │
│  │ • 持仓查询   │  │ • 财经新闻   │  │              │  │              │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
┌──────────────────────────────────────▼──────────────────────────────────────┐
│                            基础设施层 (Infrastructure Layer)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                           MongoDB 数据库                              │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  时间序列集合 (Time Series Collections)                         │  │  │
│  │  │  • market_data (OHLCV + 技术指标)                              │  │  │
│  │  │  • technical_indicators (RSI, MACD, MA...)                     │  │  │
│  │  │  • market_statistics (成交量、持仓量...)                        │  │  │
│  │  │                                                                 │  │  │
│  │  │  普通集合 (Regular Collections)                                 │  │  │
│  │  │  • trades (交易记录)                                            │  │  │
│  │  │  • ai_decisions (AI决策日志)                                   │  │  │
│  │  │  • futures_contracts (合约信息)                                │  │  │
│  │  │  • portfolio_states (组合状态快照)                             │  │  │
│  │  │  • strategy_configs (策略配置)                                 │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  │  数据库配置:                                                          │  │
│  │  • 连接池: 5-50 connections                                          │  │
│  │  • 写确认级别: majority                                               │  │
│  │  • 读优先级: primaryPreferred                                        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                            Redis 缓存                                 │  │
│  │  • 市场数据缓存 (5分钟TTL)                                             │  │
│  │  • 会话存储                                                            │  │
│  │  • 分布式锁                                                            │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                          日志和监控                                    │  │
│  │  • 应用日志: logs/cherryquant_complete.log                            │  │
│  │  • AI决策日志: MongoDB ai_decisions 集合                             │  │
│  │  • 交易日志: MongoDB trades 集合                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流架构图

```
                    ┌──────────────────────────────────────┐
                    │        实时数据流 (Live Mode)         │
                    └──────────────────────────────────────┘

      CTP 交易所                                              MongoDB 数据库
           │                                                      ▲
           │ Tick 数据                                            │
           ▼                                                      │
    ┌─────────────┐                                              │
    │ VNPy Gateway│                                              │
    │  (CTP 连接) │                                              │
    └──────┬──────┘                                              │
           │                                                      │
           │ Tick Events (EVENT_TICK)                            │
           ▼                                                      │
    ┌─────────────────┐                                          │
    │RealtimeRecorder │                                          │
    │  (Tick 聚合器)   │                                          │
    └──────┬──────────┘                                          │
           │                                                      │
           │ 聚合 K线数据                                          │
           │ • 5分钟 K线                                           │
           │ • 10分钟 K线                                          │
           │ • 30分钟 K线                                          │
           │ • 1小时 K线                                           │
           │                                                      │
           │ store_market_data()                                 │
           └──────────────────────────────────────────────────────┘


                    ┌──────────────────────────────────────┐
                    │       历史数据流 (Dev Mode)           │
                    └──────────────────────────────────────┘

      Tushare API                                            MongoDB 数据库
      (QuantBox)                                                  ▲
           │                                                      │
           │ 历史K线 + 合约信息                                     │
           ▼                                                      │
    ┌─────────────────┐                                          │
    │ MarketDataMgr   │                                          │
    │  (Dev模式)       │                                          │
    └──────┬──────────┘                                          │
           │                                                      │
           │ 批量写入                                              │
           └──────────────────────────────────────────────────────┘


                    ┌──────────────────────────────────────┐
                    │          AI 决策流程                  │
                    └──────────────────────────────────────┘

    ┌─────────────┐        ┌──────────────┐        ┌─────────────┐
    │ 策略代理      │  读取  │  MongoDB     │  写入  │   AI API    │
    │ (Agent)     │◄──────┤ (市场数据)    │───────►│(OpenAI/GLM) │
    └──────┬──────┘        └──────────────┘        └──────┬──────┘
           │                                               │
           │ 请求决策                                       │ AI响应
           └───────────────────┐       ┌──────────────────┘
                               │       │
                               ▼       ▼
                          ┌────────────────┐
                          │ DecisionEngine │
                          │  (决策引擎)     │
                          └────────┬───────┘
                                   │
                                   │ 决策结果
                                   │ (JSON格式)
                                   ▼
                          ┌────────────────┐
                          │  RiskManager   │
                          │  (风险检查)     │
                          └────────┬───────┘
                                   │
                         ┌─────────┴─────────┐
                         │                   │
                    通过  │              拒绝 │
                         ▼                   ▼
                  ┌─────────────┐    ┌─────────────┐
                  │ 执行交易订单  │    │ 记录并跳过   │
                  └─────────────┘    └─────────────┘
                         │                   │
                         └─────────┬─────────┘
                                   │
                                   ▼
                          ┌────────────────┐
                          │    MongoDB     │
                          │ (ai_decisions) │
                          └────────────────┘


                    ┌──────────────────────────────────────┐
                    │        交易执行流程                    │
                    └──────────────────────────────────────┘

    ┌─────────────┐        ┌──────────────┐        ┌─────────────┐
    │ 策略Agent    │  发送  │ VNPy Gateway │  提交  │ CTP 交易所   │
    │ (决策执行)   │───────►│ (订单管理)    │───────►│ (柜台系统)   │
    └─────────────┘        └──────┬───────┘        └──────┬──────┘
                                  │                       │
                                  │ EVENT_ORDER          │ 成交回报
                                  │ EVENT_TRADE          │
                                  ▼                       ▼
                          ┌────────────────┐     ┌────────────────┐
                          │  订单回调       │     │   成交回调      │
                          │ (_on_order)    │     │ (_on_trade)    │
                          └────────┬───────┘     └────────┬───────┘
                                   │                      │
                                   └──────────┬───────────┘
                                              │
                                              ▼
                                     ┌─────────────────┐
                                     │    MongoDB      │
                                     │   (trades)      │
                                     └─────────────────┘
```

---

## 🗂️ 目录结构

```
CherryQuant/
├── src/
│   ├── cherryquant/                    # 核心业务逻辑
│   │   ├── adapters/                   # 适配器层
│   │   │   ├── data_storage/           # 数据存储适配器
│   │   │   │   ├── database_manager.py           # 数据库管理器 (MongoDB)
│   │   │   │   ├── mongodb_manager.py            # MongoDB 连接管理
│   │   │   │   └── timeframe_data_manager.py     # 时间周期数据管理
│   │   │   ├── data_adapter/           # 数据接入适配器
│   │   │   │   ├── market_data_manager.py        # 市场数据管理器
│   │   │   │   ├── contract_resolver.py          # 合约解析器
│   │   │   │   └── multi_symbol_manager.py       # 多品种数据管理
│   │   │   └── vnpy_recorder/          # VNPy 实时数据记录器
│   │   │       └── realtime_recorder.py          # Tick → K线聚合器
│   │   ├── ai/                         # AI 决策模块
│   │   │   ├── agents/                 # 策略代理
│   │   │   │   ├── agent_manager.py              # 代理管理器
│   │   │   │   └── strategy_agent.py             # 策略代理
│   │   │   ├── decision_engine/        # 决策引擎
│   │   │   │   └── futures_engine.py             # 期货决策引擎
│   │   │   └── llm_client/             # LLM 客户端
│   │   │       └── openai_client.py              # OpenAI/GLM 客户端
│   │   ├── cherry_quant_strategy.py    # VNPy CTA 策略
│   │   └── web/                        # Web API
│   │       └── api/
│   │           └── main.py                       # FastAPI 应用
│   ├── trading/                        # 交易模块
│   │   └── vnpy_gateway.py             # VNPy CTP 网关封装
│   ├── risk/                           # 风险管理
│   │   └── portfolio_risk_manager.py   # 组合风险管理器
│   └── alerts/                         # 警报系统
│       └── alert_manager.py            # 警报管理器
├── config/                             # 配置文件
│   ├── settings/                       # 系统设置
│   │   ├── base.py                     # 基础配置
│   │   └── settings.py                 # 全局配置对象
│   ├── database_config.py              # 数据库配置
│   ├── strategy_pools.json             # 策略品种池配置
│   └── strategies.json                 # 策略配置
├── scripts/                            # 脚本工具
│   └── init_historical_data.py         # 历史数据初始化
├── logs/                               # 日志目录
│   └── cherryquant_complete.log        # 系统日志
├── .env                                # 环境变量配置
├── pyproject.toml                      # 项目依赖配置
├── run_cherryquant_complete.py         # 系统启动脚本
├── TEST_REPORT.md                      # 测试报告
└── ARCHITECTURE.md                     # 架构文档 (本文件)
```

---

## 🔧 技术栈

### 后端框架
- **Python 3.12**: 主要编程语言
- **FastAPI**: Web API 框架
- **Uvicorn**: ASGI 服务器
- **Asyncio**: 异步 I/O 框架

### 数据库
- **MongoDB 5.0+**: 文档数据库 + 时间序列集合
- **Motor**: 异步 MongoDB 驱动
- **Redis 7.0+**: 缓存和会话存储
- **aioredis**: 异步 Redis 客户端

### 交易系统
- **VNPy 4.1.0**: Python 交易框架
- **vnpy_ctp 6.7.7.2**: CTP 期货网关
- **vnpy_ctastrategy 1.3.3**: CTA 策略模块

### 数据源
- **Tushare Pro**: 历史数据和财经数据
- **QuantBox**: 期货数据增强包
- **CTP API**: 实时 Tick 数据

### AI 模型
- **OpenAI GPT-4**: 主 AI 决策引擎
- **智谱 GLM-4**: 备用 AI 模型
- **httpx**: 异步 HTTP 客户端

### 数据处理
- **Pandas 2.3+**: 数据分析
- **NumPy 2.3+**: 数值计算
- **pytz**: 时区处理

### 开发工具
- **uv**: Python 包管理器
- **pytest**: 测试框架
- **black**: 代码格式化
- **ruff**: 代码检查

---

## 🌊 关键数据流

### 1. 实时数据流 (Live Mode)
```
CTP交易所 → VNPy Gateway → RealtimeRecorder → K线聚合 → MongoDB
                                                          ↓
                                             策略Agent ← 读取数据
                                                          ↓
                                                     AI决策引擎
                                                          ↓
                                                     风险检查
                                                          ↓
                                             VNPy Gateway → CTP交易所
```

### 2. 历史数据流 (Dev Mode)
```
Tushare API → MarketDataManager → 批量写入 → MongoDB
                                                ↓
                                   策略Agent ← 读取数据
```

### 3. AI 决策流
```
市场数据 → 策略Agent → DecisionEngine → AI API → 决策结果
                                                    ↓
                                              RiskManager
                                                    ↓
                                        通过 → 执行交易 → MongoDB (trades)
                                        拒绝 → 记录日志 → MongoDB (ai_decisions)
```

---

## 📊 性能特性

### 并发性能
- **异步架构**: 基于 asyncio 的全异步架构
- **并发策略**: 5个策略代理并行运行
- **连接池**: MongoDB 5-50 连接，Redis 自动管理

### 数据性能
- **写入性能**: ~5ms/条 (MongoDB insert_many)
- **读取性能**: ~3ms/10条 (MongoDB find)
- **缓存命中**: Redis 5分钟 TTL，减少 DB 查询

### 系统性能
- **启动时间**: ~2秒 (全系统初始化)
- **AI决策**: ~13秒/次 (取决于 AI API 响应)
- **内存占用**: ~150MB (5个策略运行时)

---

## 🔐 安全特性

### 数据安全
- **环境变量**: 敏感信息存储在 .env 文件
- **连接加密**: MongoDB 支持 TLS/SSL
- **密码保护**: Redis 密码认证

### 交易安全
- **风险限制**: 仓位、杠杆、单笔交易限制
- **决策验证**: AI 置信度阈值过滤
- **止损保护**: 自动止损和止盈

### 系统安全
- **日志审计**: 完整的交易和决策日志
- **异常处理**: 全局异常捕获和恢复
- **优雅关闭**: 信号处理和资源清理

---

*文档生成时间: 2025-11-13*
*版本: v0.1.0*
