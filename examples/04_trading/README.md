# 04 äº¤æ˜“æ‰§è¡Œ

## æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«äº¤æ˜“æ‰§è¡Œç›¸å…³çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•å°† AI å†³ç­–è½¬åŒ–ä¸ºå®žé™…çš„äº¤æ˜“æŒ‡ä»¤ï¼Œä»¥åŠé£Žé™©ç®¡ç†ç³»ç»Ÿçš„ä½¿ç”¨ã€‚

## å­¦ä¹ ç›®æ ‡

- ðŸŽ¯ ç†è§£äº¤æ˜“æ‰§è¡Œæµç¨‹
- ðŸ›¡ï¸ æŽŒæ¡é£Žé™©ç®¡ç†æœºåˆ¶
- ðŸ“Š å­¦ä¹ è®¢å•ç®¡ç†ç³»ç»Ÿ
- âš ï¸ äº†è§£å¼‚å¸¸å¤„ç†å’Œå®¹é”™

## âš ï¸ é‡è¦æç¤º

**æœ¬é¡¹ç›®æ˜¯æ•™å­¦é¡¹ç›®ï¼Œæ‰€æœ‰ç¤ºä¾‹ä½¿ç”¨æ¨¡æ‹ŸçŽ¯å¢ƒï¼Œç¦æ­¢è¿žæŽ¥çœŸå®žäº¤æ˜“è´¦æˆ·ï¼**

- âœ… ä½¿ç”¨ VNPy çš„ SimNow æ¨¡æ‹Ÿè´¦æˆ·
- âœ… ä½¿ç”¨æ¨¡æ‹Ÿèµ„é‡‘è¿›è¡Œæµ‹è¯•
- âŒ **ä¸¥ç¦**ä½¿ç”¨çœŸå®žæœŸè´§è´¦æˆ·
- âŒ **ä¸¥ç¦**æŠ•å…¥çœŸå®žèµ„é‡‘

## ç¤ºä¾‹åˆ—è¡¨

### `order_management.py` (å³å°†æ·»åŠ )
**éš¾åº¦**: â­â­ åˆçº§

**æè¿°**: æ¼”ç¤ºè®¢å•çš„åˆ›å»ºã€å‘é€ã€æŸ¥è¯¢å’Œæ’¤é”€ã€‚

**å­¦ä¹ è¦ç‚¹**:
- VNPy OrderRequest æž„å»º
- è®¢å•çŠ¶æ€ç®¡ç†
- è®¢å•æŸ¥è¯¢å’Œæ’¤å•
- æˆäº¤å›žæŠ¥å¤„ç†

**è¿è¡Œæ–¹å¼**:
```bash
uv run python examples/04_trading/order_management.py
```

---

### `risk_management.py` (å³å°†æ·»åŠ )
**éš¾åº¦**: â­â­â­ ä¸­çº§

**æè¿°**: æ¼”ç¤ºå¤šå±‚é£Žé™©ç®¡ç†ç³»ç»Ÿã€‚

**å­¦ä¹ è¦ç‚¹**:
- ä»“ä½é£Žé™©æŽ§åˆ¶
- å•æ—¥äºæŸé™åˆ¶
- å•ç¬”äº¤æ˜“é£Žé™©
- é£Žé™©é¢„è­¦æœºåˆ¶

**é£Žé™©æŽ§åˆ¶å±‚çº§**:
```
è®¢å•çº§é£Žé™©æ£€æŸ¥
  â†“
è´¦æˆ·çº§é£Žé™©æ£€æŸ¥
  â†“
ç³»ç»Ÿçº§é£Žé™©æ£€æŸ¥
  â†“
æ‰§è¡Œäº¤æ˜“
```

---

### `position_management.py` (å³å°†æ·»åŠ )
**éš¾åº¦**: â­â­â­ ä¸­çº§

**æè¿°**: æ¼”ç¤ºæŒä»“ç®¡ç†å’Œæ­¢æŸæ­¢ç›ˆã€‚

**å­¦ä¹ è¦ç‚¹**:
- æŒä»“æŸ¥è¯¢å’Œè·Ÿè¸ª
- åŠ¨æ€æ­¢æŸæ­¢ç›ˆ
- åŠ ä»“å‡ä»“ç­–ç•¥
- å¼ºåˆ¶å¹³ä»“æœºåˆ¶

**æ­¢æŸæ­¢ç›ˆç­–ç•¥**:
- å›ºå®šä»·æ ¼æ­¢æŸ
- ç™¾åˆ†æ¯”æ­¢æŸ
- ç§»åŠ¨æ­¢æŸï¼ˆTrailing Stopï¼‰
- ATR æ­¢æŸ

---

### `execution_strategies.py` (å³å°†æ·»åŠ )
**éš¾åº¦**: â­â­â­â­ é«˜çº§

**æè¿°**: æ¼”ç¤ºä¸åŒçš„è®¢å•æ‰§è¡Œç­–ç•¥ã€‚

**å­¦ä¹ è¦ç‚¹**:
- å¸‚ä»·å• vs é™ä»·å•
- TWAP æ‰§è¡Œç­–ç•¥
- å†°å±±å§”æ‰˜
- æ™ºèƒ½æ‹†å•

---

## æž¶æž„è¯´æ˜Ž

### äº¤æ˜“æ‰§è¡Œç»„ä»¶

```
TradingExecutor
    â”œâ”€â”€ OrderManager (è®¢å•ç®¡ç†å™¨)
    â”œâ”€â”€ RiskManager (é£Žé™©ç®¡ç†å™¨)
    â”œâ”€â”€ PositionManager (æŒä»“ç®¡ç†å™¨)
    â””â”€â”€ VNPyGateway (äº¤æ˜“ç½‘å…³)
```

### æ‰§è¡Œæµç¨‹

```
AI å†³ç­–
  â†“
é£Žé™©æ£€æŸ¥ (è´¦æˆ·èµ„é‡‘ã€ä»“ä½é™åˆ¶)
  â†“
è®¢å•æž„å»º (åˆçº¦ã€æ–¹å‘ã€æ•°é‡ã€ä»·æ ¼)
  â†“
è®¢å•å‘é€
  â†“
è®¢å•å›žæŠ¥ (çŠ¶æ€æ›´æ–°)
  â†“
æŒä»“æ›´æ–°
  â†“
æ­¢æŸæ­¢ç›ˆç›‘æŽ§
```

## å‰ç½®è¦æ±‚

### çŽ¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®äº¤æ˜“ç›¸å…³å‚æ•°ï¼š

```bash
# === é£Žé™©ç®¡ç†é…ç½® ===
# å•ç¬”äº¤æ˜“æœ€å¤§ä»“ä½æ¯”ä¾‹ (0-1)
MAX_POSITION_RATIO=0.3

# å•æ—¥æœ€å¤§äºæŸæ¯”ä¾‹ (0-1)
MAX_DAILY_LOSS_RATIO=0.05

# è´¦æˆ·æ€»é£Žé™©æ•žå£é™åˆ¶ (0-1)
MAX_TOTAL_RISK_RATIO=0.8

# å•ä¸ªå“ç§æœ€å¤§æŒä»“æ‰‹æ•°
MAX_POSITION_SIZE=10

# æ˜¯å¦å¯ç”¨å¼ºåˆ¶æ­¢æŸ
ENABLE_FORCE_STOP_LOSS=true

# å¼ºåˆ¶æ­¢æŸè§¦å‘æ¡ä»¶: è´¦æˆ·èµ„é‡‘äºæŸæ¯”ä¾‹
FORCE_STOP_LOSS_RATIO=0.10
```

### VNPy CTP é…ç½®

```bash
# CTP æŽ¥å£é…ç½® (SimNow æ¨¡æ‹ŸçŽ¯å¢ƒ)
CTP_USERID=123456
CTP_PASSWORD=your_password
CTP_BROKERID=9999
CTP_MD_ADDRESS=tcp://180.168.146.187:10211
CTP_TD_ADDRESS=tcp://180.168.146.187:10201
CTP_APPID=simnow_client_test
CTP_AUTH_CODE=0000000000000000
```

### SimNow æ¨¡æ‹Ÿè´¦æˆ·ç”³è¯·

1. è®¿é—® http://www.simnow.com.cn/
2. æ³¨å†Œå¹¶èŽ·å–æ¨¡æ‹Ÿè´¦æˆ·
3. é…ç½®åˆ° `.env` æ–‡ä»¶
4. **æ³¨æ„**: æ¯æ—¥æ”¶ç›˜åŽè´¦æˆ·ä¼šé‡ç½®

## é£Žé™©ç®¡ç†è§„åˆ™

### 1. ä»“ä½æŽ§åˆ¶

```python
# å•ç¬”äº¤æ˜“ä»“ä½æ£€æŸ¥
def check_position_limit(symbol: str, quantity: int) -> bool:
    current_position = get_position(symbol)
    max_position = MAX_POSITION_SIZE

    if current_position + quantity > max_position:
        return False  # è¶…è¿‡ä»“ä½é™åˆ¶
    return True
```

### 2. èµ„é‡‘ç®¡ç†

```python
# è´¦æˆ·èµ„é‡‘æ£€æŸ¥
def check_account_balance(required_margin: float) -> bool:
    available_balance = get_available_balance()

    if available_balance < required_margin * 1.2:  # ä¿ç•™ 20% ç¼“å†²
        return False  # èµ„é‡‘ä¸è¶³
    return True
```

### 3. æ­¢æŸæ­¢ç›ˆ

```python
# åŠ¨æ€æ­¢æŸ
def update_stop_loss(symbol: str, entry_price: float):
    stop_loss_price = entry_price * (1 - STOP_LOSS_RATIO)
    take_profit_price = entry_price * (1 + TAKE_PROFIT_RATIO)

    # è®¾ç½®æ¡ä»¶å•
    set_stop_order(symbol, stop_loss_price, "SELL")
    set_stop_order(symbol, take_profit_price, "SELL")
```

## ç›¸å…³è¯¾ç¨‹æ¨¡å—

- **Module 4**: äº¤æ˜“æ‰§è¡Œä¸Žé£Žé™©ç®¡ç†
- **docs/reference/advanced/RISK_CONFIG_GUIDE.md**: é£Žé™©é…ç½®è¯¦è§£
- **Lab 04**: é£Žé™©ç®¡ç†ç³»ç»Ÿå®žéªŒ

## å¸¸è§é—®é¢˜

**Q: å¦‚ä½•è¿žæŽ¥ SimNow æ¨¡æ‹ŸçŽ¯å¢ƒ?**

A: æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
1. åœ¨ SimNow å®˜ç½‘æ³¨å†Œæ¨¡æ‹Ÿè´¦æˆ·
2. é…ç½® `.env` æ–‡ä»¶ä¸­çš„ CTP å‚æ•°
3. è¿è¡Œç¤ºä¾‹ç¨‹åºè‡ªåŠ¨è¿žæŽ¥

**Q: è®¢å•è¢«æ‹’ç»ï¼Œæç¤º"èµ„é‡‘ä¸è¶³"?**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- æ¨¡æ‹Ÿè´¦æˆ·æ˜¯å¦æœ‰åˆå§‹èµ„é‡‘
- è®¡ç®—çš„ä¿è¯é‡‘æ˜¯å¦æ­£ç¡®
- æ˜¯å¦è®¾ç½®äº†è¿‡é«˜çš„ä»“ä½

**Q: æ­¢æŸå•æ²¡æœ‰è§¦å‘?**

A: å¯èƒ½åŽŸå› ï¼š
- æ­¢æŸä»·æ ¼è®¾ç½®ä¸åˆç†
- å¸‚åœºæœªè¾¾åˆ°æ­¢æŸæ¡ä»¶
- æ¡ä»¶å•çŠ¶æ€æ£€æŸ¥ï¼ˆæ˜¯å¦æ¿€æ´»ï¼‰

**Q: å¦‚ä½•æµ‹è¯•é£Žé™©ç®¡ç†ç³»ç»Ÿ?**

A: å»ºè®®çš„æµ‹è¯•æµç¨‹ï¼š
1. ä½¿ç”¨å°èµ„é‡‘è´¦æˆ·æµ‹è¯•
2. æ¨¡æ‹Ÿæžç«¯è¡Œæƒ…ï¼ˆå¤§å¹…æ³¢åŠ¨ï¼‰
3. æµ‹è¯•å„ç§é£Žé™©è§¦å‘æ¡ä»¶
4. éªŒè¯é£Žé™©é¢„è­¦å’Œå¼ºåˆ¶å¹³ä»“

**Q: è®¢å•çŠ¶æ€æœ‰å“ªäº›?**

A: VNPy è®¢å•çŠ¶æ€ï¼š
- `SUBMITTING`: æäº¤ä¸­
- `NOTTRADED`: æœªæˆäº¤
- `PARTTRADED`: éƒ¨åˆ†æˆäº¤
- `ALLTRADED`: å…¨éƒ¨æˆäº¤
- `CANCELLED`: å·²æ’¤é”€
- `REJECTED`: è¢«æ‹’ç»

## è®¢å•ç±»åž‹è¯´æ˜Ž

### 1. å¸‚ä»·å•ï¼ˆMarket Orderï¼‰

```python
order = OrderRequest(
    symbol="rb2501",
    exchange=Exchange.SHFE,
    direction=Direction.LONG,
    type=OrderType.MARKET,  # å¸‚ä»·å•
    volume=1
)
```

**ç‰¹ç‚¹**:
- âœ… å¿«é€Ÿæˆäº¤
- âŒ ä»·æ ¼ä¸ç¡®å®šï¼ˆæ»‘ç‚¹é£Žé™©ï¼‰

### 2. é™ä»·å•ï¼ˆLimit Orderï¼‰

```python
order = OrderRequest(
    symbol="rb2501",
    exchange=Exchange.SHFE,
    direction=Direction.LONG,
    type=OrderType.LIMIT,   # é™ä»·å•
    price=3500.0,
    volume=1
)
```

**ç‰¹ç‚¹**:
- âœ… ä»·æ ¼å¯æŽ§
- âŒ å¯èƒ½ä¸æˆäº¤

### 3. æ¡ä»¶å•ï¼ˆStop Orderï¼‰

```python
# æ­¢æŸå•ï¼šä»·æ ¼è·Œç ´ 3450 è§¦å‘å–å‡º
stop_order = StopOrder(
    symbol="rb2501",
    direction=Direction.SHORT,
    stop_price=3450.0,
    volume=1
)
```

## å›žæµ‹ vs å®žç›˜

| å¯¹æ¯”é¡¹ | å›žæµ‹ | æ¨¡æ‹Ÿç›˜ | å®žç›˜ |
|-------|------|--------|------|
| æ•°æ®æ¥æº | åŽ†å²æ•°æ® | å®žæ—¶è¡Œæƒ… | å®žæ—¶è¡Œæƒ… |
| è®¢å•æ‰§è¡Œ | ç†æƒ³åŒ– | æ¨¡æ‹Ÿæ’®åˆ | çœŸå®žæ’®åˆ |
| æ»‘ç‚¹ | å¯é…ç½® | æ¨¡æ‹Ÿ | çœŸå®žå­˜åœ¨ |
| èµ„é‡‘é£Žé™© | æ—  | æ—  | **æœ‰** |
| é€‚ç”¨åœºæ™¯ | ç­–ç•¥éªŒè¯ | ç³»ç»Ÿæµ‹è¯• | ç”Ÿäº§äº¤æ˜“ |

**æ•™å­¦å»ºè®®**: æœ¬è¯¾ç¨‹æ‰€æœ‰ç¤ºä¾‹å‡åœ¨**æ¨¡æ‹Ÿç›˜**çŽ¯å¢ƒè¿è¡Œã€‚

## å®‰å…¨æ¸…å•

åœ¨è¿è¡Œäº¤æ˜“ç¤ºä¾‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] ä½¿ç”¨çš„æ˜¯ SimNow æ¨¡æ‹Ÿè´¦æˆ·
- [ ] `.env` ä¸­æ²¡æœ‰çœŸå®žè´¦æˆ·ä¿¡æ¯
- [ ] ç†è§£æ‰€æœ‰é£Žé™©ç®¡ç†å‚æ•°
- [ ] å·²è®¾ç½®åˆç†çš„ä»“ä½å’Œæ­¢æŸ
- [ ] æœ‰åº”æ€¥æ­¢æŸé¢„æ¡ˆ

## ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç›®å½•ç¤ºä¾‹åŽï¼Œç»§ç»­å­¦ä¹ ï¼š
- **complete_system**: å®Œæ•´ç³»ç»Ÿé›†æˆï¼ˆæ•°æ®â†’AIâ†’äº¤æ˜“ï¼‰
- **docs/course/04_Trading_Execution.md**: æ·±å…¥å­¦ä¹ äº¤æ˜“æ‰§è¡Œ
- **å®žæˆ˜é¡¹ç›®**: æž„å»ºè‡ªå·±çš„äº¤æ˜“ç­–ç•¥

---

ðŸ’¡ **å­¦ä¹ æç¤º**: äº¤æ˜“æ‰§è¡Œæ˜¯å°†ç†è®ºè½¬åŒ–ä¸ºå®žè·µçš„å…³é”®çŽ¯èŠ‚ï¼ŒåŠ¡å¿…æ·±å…¥ç†è§£é£Žé™©ç®¡ç†çš„é‡è¦æ€§ã€‚

âš ï¸ **å®‰å…¨æé†’**:
1. **æ°¸è¿œä¸è¦**å°†æ•™å­¦é¡¹ç›®ç”¨äºŽçœŸå®žäº¤æ˜“
2. **æ°¸è¿œä¸è¦**è·³è¿‡é£Žé™©æ£€æŸ¥
3. **æ°¸è¿œä¸è¦**åœ¨ä¸ç†è§£çš„æƒ…å†µä¸‹ä¿®æ”¹é£Žé™©å‚æ•°
4. **å§‹ç»ˆ**ä¿æŒè°¨æ…Žå’Œæ•¬ç•ä¹‹å¿ƒ
